(window.webpackJsonp=window.webpackJsonp||[]).push([[164],{644:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"k8s集群部署与安全配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s集群部署与安全配置"}},[s._v("#")]),s._v(" K8S集群部署与安全配置")]),s._v(" "),a("h3",{attrs:{id:"主要内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[s._v("#")]),s._v(" 主要内容")]),s._v(" "),a("p",[s._v("❖ K8s安全运维概述")]),s._v(" "),a("p",[s._v("❖ 部署一套完整的K8s高可用集群")]),s._v(" "),a("p",[s._v("❖ CIS 安全基准介绍与K8s安全基准工具kube-bench")]),s._v(" "),a("p",[s._v("❖ Ingress 配置证书")]),s._v(" "),a("p",[s._v("❖ 网络策略控制集群内部网络通信")]),s._v(" "),a("h3",{attrs:{id:"k8s安全运维概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s安全运维概述"}},[s._v("#")]),s._v(" K8s安全运维概述")]),s._v(" "),a("ul",[a("li",[s._v("安全运维的重要性")]),s._v(" "),a("li",[s._v("SecDevOps")]),s._v(" "),a("li",[s._v("K8s提供的安全机制")]),s._v(" "),a("li",[s._v("K8s安全运维实践思路")])]),s._v(" "),a("h3",{attrs:{id:"安全运维的重要性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全运维的重要性"}},[s._v("#")]),s._v(" 安全运维的重要性")]),s._v(" "),a("ul",[a("li",[s._v("万物互联，安全为基，企业的网络安全不可小视")]),s._v(" "),a("li",[s._v("服务器被黑事件频发")]),s._v(" "),a("li",[s._v("公司重要数据资产在运维手中")])]),s._v(" "),a("h3",{attrs:{id:"secdevops"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#secdevops"}},[s._v("#")]),s._v(" SecDevOps")]),s._v(" "),a("p",[s._v("SecDevOps与DevOps相似，是一种哲学，鼓励运维人员、开发 人员、测试人员和安全人员进行更高水水平协作，将信息安全被放 在事前考虑，将安全性注入自动化流程中，以确保整个产品周期内 的信息安全。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111435904.png",alt:"image-20220411143502253"}})]),s._v(" "),a("h3",{attrs:{id:"k8s提供的安全机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s提供的安全机制"}},[s._v("#")]),s._v(" K8s提供的安全机制")]),s._v(" "),a("p",[s._v("为了保证集群以及容器应用的安全，Kubernetes 提供了多 种安全机制，限制容器的行为，减少容器和集群的攻击面， 保证整个系统的安全性。")]),s._v(" "),a("ol",[a("li",[s._v("**集群安全：**TLS证书认证、RBAC")]),s._v(" "),a("li",[s._v("**Security Context：**限制容器的行为，例如只读文件系统、特权、运行用户等")]),s._v(" "),a("li",[s._v("**Pod Security Policy：**集群级的 Pod 安全策略，自动为集群内的 Pod 配置安全策略")]),s._v(" "),a("li",[s._v("**Sysctls：**允许容器设置内核参数")]),s._v(" "),a("li",[s._v("**AppArmor：**限制容器中应用对资源的访问权限")]),s._v(" "),a("li",[s._v("**Network Policies：**控制集群中网络通信")]),s._v(" "),a("li",[s._v("**Seccomp：**限制容器内进程的系统调用")])]),s._v(" "),a("h3",{attrs:{id:"k8s安全运维实践思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s安全运维实践思路"}},[s._v("#")]),s._v(" K8s安全运维实践思路")]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151113618.png",alt:"image-20220411143733252"}}),s._v(" "),a("h3",{attrs:{id:"cis-安全基准"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cis-安全基准"}},[s._v("#")]),s._v(" CIS 安全基准")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("CIS安全基准介绍")])]),s._v(" "),a("li",[a("code",[s._v("K8s安全基准工具 kube-bench")])])]),s._v(" "),a("h4",{attrs:{id:"cis安全基准"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cis安全基准"}},[s._v("#")]),s._v(" CIS安全基准")]),s._v(" "),a("p",[s._v("互联网安全中心（CIS，Center for Internet Security），是一个非盈利组织，致力为互联网提供 免费的安全防御解决方案。")]),s._v(" "),a("p",[s._v("官网：https://www.cisecurity.org/")]),s._v(" "),a("p",[s._v("Kubernetes CIS基准：https://www.cisecurity.org/benchmark/kubernetes/")]),s._v(" "),a("h4",{attrs:{id:"cis基准测试工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cis基准测试工具"}},[s._v("#")]),s._v(" CIS基准测试工具")]),s._v(" "),a("p",[s._v("Kube-bench是容器安全厂商Aquq推出的工具，以CIS K8s基准作为基础，来检查K8s是否安全部署。 主要查找不安全的配置参数、敏感的文件权限、不安全的帐户或公开端口等等。")]),s._v(" "),a("p",[s._v("项目地址：https://github.com/aquasecurity/kube-bench")]),s._v(" "),a("h4",{attrs:{id:"kube-beach部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kube-beach部署"}},[s._v("#")]),s._v(" kube-beach部署")]),s._v(" "),a("p",[a("strong",[s._v("1、下载二进制包")])]),s._v(" "),a("p",[s._v("https://github.com/aquasecurity/kube-bench/releases")]),s._v(" "),a("p",[a("strong",[s._v("2、解压使用")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf kube-bench_0.6.3_linux_amd64.tar.gz ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/kube-bench \t\t\t# 创建默认配置文件路径")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv cfg /etc/kube-bench/cfg")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("strong",[s._v("3、kube-beach使用")])]),s._v(" "),a("p",[s._v("使用kube-bench run进行测试，该指令有以下常用参数：")]),s._v(" "),a("p",[s._v("常用参数：")]),s._v(" "),a("ul",[a("li",[a("strong",[a("code",[s._v("-s, --targets")])]),s._v("  指定要基础测试的目标，这个目标需要匹配cfg/中的 文件名称，已有目标：master, controlplane, node, etcd, policies")]),s._v(" "),a("li",[a("strong",[a("code",[s._v("--version：")])]),s._v(" 指定k8s版本，如果未指定会自动检测")]),s._v(" "),a("li",[s._v("**"),a("code",[s._v("--benchmark：")]),s._v("**手动指定CIS基准版本，不能与--version一起使用")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111504870.png",alt:"image-20220411150422457"}})]),s._v(" "),a("p",[a("strong",[s._v("4、运行kube-beach")])]),s._v(" "),a("p",[a("code",[s._v("检查master组件安全配置，需要指定当前的cis目录。")])]),s._v(" "),a("p",[s._v("**[PASS]：**测试通过")]),s._v(" "),a("p",[s._v("**[FAIL]：**测试未通过，重点关注，在测试结果会给出修复建议")]),s._v(" "),a("p",[s._v("**[WARN]：**警告，可做了解")]),s._v(" "),a("p",[s._v("**[INFO]：**信息")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd cfg/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/cfg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kube-bench run master --config-dir .")]),s._v("\n···\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" Summary policies "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" checks PASS\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" checks FAIL\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" checks WARN\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" checks INFO\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" Summary total "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" checks PASS\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" checks FAIL\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(" checks WARN\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" checks INFO\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("如下是检查后需要建议修复的地方")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111515804.png",alt:"image-20220411151549372"}})]),s._v(" "),a("p",[s._v("kube-beach工具将会给出修改建议的方案，可以参考做修改：")]),s._v(" "),a("ul",[a("li",[s._v("1.2.16的建议是： "),a("strong",[a("code",[s._v("开启Pod安全策略准入控制器")])])]),s._v(" "),a("li",[s._v("1.2.22的建议是： "),a("strong",[a("code",[s._v("开启日志审计的数据存放路径")])])]),s._v(" "),a("li",[s._v("1.2.23的建议是： "),a("strong",[a("code",[s._v("设置日志最大页数为30")])])]),s._v(" "),a("li",[s._v("1.2.24的建议是： "),a("strong",[a("code",[s._v("设置日志最大的备份数为10")])])]),s._v(" "),a("li",[s._v("1.2.25的建议是： "),a("strong",[a("code",[s._v("设置日志的大小为100M")])])]),s._v(" "),a("li",[s._v("1.2.26的建议是： "),a("strong",[a("code",[s._v("设置请求超时为300s")])])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".16 Follow the documentation and create Pod Security Policy objects as per your environment.\nThen, edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\non the master "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the --enable-admission-plugins parameter to a\nvalue that includes PodSecurityPolicy:\n--enable-admission-plugins"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".,PodSecurityPolicy,"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nThen restart the API Server.\n\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".22 Edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\non the master "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the --audit-log-path parameter to a suitable path and\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" where you would like audit logs to be written, "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" example:\n--audit-log-path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/apiserver/audit.log\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".23 Edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\non the master "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the --audit-log-maxage parameter to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" or as an appropriate number of days:\n--audit-log-maxage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".24 Edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\non the master "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the --audit-log-maxbackup parameter to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" or to an appropriate\nvalue.\n--audit-log-maxbackup"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".25 Edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\non the master "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the --audit-log-maxsize parameter to an appropriate size "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" MB.\nFor example, to "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" it as "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" MB:\n--audit-log-maxsize"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".26 Edit the API server pod specification "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/kubernetes/manifests/kube-apiserver.yaml\nand "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the below parameter as appropriate and "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" needed.\nFor example,\n--request-timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("300s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("p",[s._v("按照1.2.16建议我们修改之后再次检查：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("enable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admission"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plugins=NodeRestriction"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("PodSecurityPolicy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151355608.png",alt:"image-20220411152909508"}})]),s._v(" "),a("h3",{attrs:{id:"ingress配置证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress配置证书"}},[s._v("#")]),s._v(" Ingress配置证书")]),s._v(" "),a("ul",[a("li",[a("strong",[a("code",[s._v("Ingress是什么")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("HTTPS重要性")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("将一个项目对外暴露HTTPS访问")])])])]),s._v(" "),a("h4",{attrs:{id:"ingress是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress是什么"}},[s._v("#")]),s._v(" Ingress是什么？")]),s._v(" "),a("p",[s._v("Ingress：K8s中的一个抽象资源，给管理员 提供一个暴露应用的入口定义方法")]),s._v(" "),a("p",[s._v("Ingress Controller：根据Ingress生成具体 的路由规则，并对Pod负载均衡器")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111537973.png",alt:"image-20220411153701818"}})]),s._v(" "),a("h4",{attrs:{id:"https重要性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#https重要性"}},[s._v("#")]),s._v(" HTTPS重要性")]),s._v(" "),a("p",[s._v("HTTPS是安全的HTTP，HTTP 协议中的内容都是明文传输，HTTPS 的目的是将这 些内容加密，确保信息传输安全。最后一个字母 S 指的是 SSL/TLS 协议，它位于 HTTP 协议与 TCP/IP 协议中间。")]),s._v(" "),a("p",[s._v("HTTPS优势：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("加密隐私数据：")]),s._v("防止您访客的隐私信息(账号、地址、手机号等)被劫持或窃取。")]),s._v(" "),a("li",[a("code",[s._v("安全身份认证：")]),s._v("验证网站的真实性，防止钓鱼网站。")]),s._v(" "),a("li",[a("code",[s._v("防止网页篡改：")]),s._v("防止数据在传输过程中被篡改，保护用户体验。")]),s._v(" "),a("li",[a("code",[s._v("地址栏安全锁：")]),s._v("地址栏头部的“锁”型图标，提高用户信任度。")]),s._v(" "),a("li",[a("code",[s._v("提高SEO排名：")]),s._v("提高搜索排名顺序，为企业带来更多访问量。")])]),s._v(" "),a("h4",{attrs:{id:"将一个项目对外暴露https访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将一个项目对外暴露https访问"}},[s._v("#")]),s._v(" 将一个项目对外暴露HTTPS访问")]),s._v(" "),a("p",[s._v("配置HTTPS步骤：")]),s._v(" "),a("p",[s._v("1、准备域名证书文件（来自：openssl/cfssl工具自签或者权威机构颁发）")]),s._v(" "),a("p",[s._v("2、将证书文件保存到Secret")]),s._v(" "),a("blockquote",[a("p",[s._v("kubectl create secret tls web-aliangedu-cn -- cert=web.aliangedu.cn.pem --key=web.aliangedu.cn-key.pem")])]),s._v(" "),a("p",[s._v("3、Ingress规则配置tls")]),s._v(" "),a("p",[s._v("4、kubectl get ingress")]),s._v(" "),a("p",[s._v("5、测试，本地电脑绑定hosts记录对应ingress里面配置的域名，IP是 Ingress Concontroller Pod节点IP")]),s._v(" "),a("p",[s._v("1."),a("strong",[s._v("配置自签名的域名证书文件")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls ")]),s._v("\ncerts.sh  cfssl  cfssl-certinfo  cfssljson  cfssl.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv cfssl* /usr/local/bin/ ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./certs.sh ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating a new CA key and certificate from CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28750654571656584514635094557307694380858081500")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("399813817984941992535618075144209803695431465162")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/04/11 08:13:18 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" This certificate lacks a "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hosts"')]),s._v(" field. This makes it unsuitable "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v("\nwebsites. For "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information see the Baseline Requirements "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("https://cabforum.org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nspecifically, section "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.2")]),s._v(".3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Information Requirements"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create secret tls web-aliangedu-cn --cert=web.aliangedu.cn.pem --key=web.aliangedu.cn-key.pem ")]),s._v("\nsecret/web-aliangedu-cn created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[a("strong",[s._v("2.创建应用测试")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create deployment web --image=nginx --port=80       ")]),s._v("\ndeployment.apps/web created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl expose deployment web --port=80 --type=NodePort ")]),s._v("\nservice/web exposed\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("3.创建Ingress服务")])]),s._v(" "),a("ul",[a("li",[s._v("创建"),a("strong",[s._v("Ingress")]),s._v("服务名称为aliangedu-https")]),s._v(" "),a("li",[s._v("使用"),a("strong",[s._v("tls")]),s._v("证书web-aliangedu-cn")]),s._v(" "),a("li",[s._v("使用"),a("strong",[s._v("host")]),s._v("为web.aliangedu.cn")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create ingress aliangedu-https --rule=web.aliangedu.cn/=web:80,tls=web-aliangedu-cn --dry-run -o yaml > ingress.yaml  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Ingress\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" aliangedu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("https\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web.aliangedu.cn\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("number")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pathType")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Exact\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tls")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" web.aliangedu.cn\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("aliangedu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cn\n    \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get ingress")]),s._v("\nNAME              CLASS    HOSTS              ADDRESS   PORTS     AGE\naliangedu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("https   <none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("   web.aliangedu.cn             80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 443   35m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("根据ingress-nginx的443端口以及master03节点的IP访问。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n ingress-nginx ")]),s._v("\nNAMESPACE       NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                      AGE\ningress-nginx   ingress-nginx-controller             NodePort    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.108")]),s._v(".51.191    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":31950/TCP,443:31465/TCP   4d4h\ningress-nginx   ingress-nginx-controller-admission   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".104.2      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP                      4d4h\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/work/cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get  pods -o wide ")]),s._v("\nNAME                   READY   STATUS    RESTARTS   AGE   IP              NODE       NOMINATED NODE   READINESS GATES\nweb-64ffb4ff88-rmvct   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          15m   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".235.12   master03   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111702010.png",alt:"image-20220411170248985"}})]),s._v(" "),a("h3",{attrs:{id:"网络访问控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络访问控制"}},[s._v("#")]),s._v(" 网络访问控制")]),s._v(" "),a("ul",[a("li",[a("strong",[a("code",[s._v("网络策略应用场景")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("网络策略概述")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("网络访问控制5个案例")])])])]),s._v(" "),a("h4",{attrs:{id:"网络访问控制-应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络访问控制-应用场景"}},[s._v("#")]),s._v(" 网络访问控制：应用场景")]),s._v(" "),a("p",[s._v("默认情况下，Kubernetes 集群网络没任何网络限制，Pod 可以与任何其他 Pod 通信，在某些场景下就需要进行网络控制， 减少网络攻击面，提高安全性，这就会用到网络策略。")]),s._v(" "),a("p",[s._v("网络策略（Network Policy）：是一个K8s资源，用于限制Pod出入流量，提供Pod级别和Namespace级别网络访问控制。")]),s._v(" "),a("p",[s._v("网络策略的应用场景：")]),s._v(" "),a("ol",[a("li",[s._v("应用程序间的访问控制，例如项目A不能访问项目B的Pod")]),s._v(" "),a("li",[s._v("开发环境命名空间不能访问测试环境命名空间Pod • 当Pod暴露到外部时，需要做Pod白名单")]),s._v(" "),a("li",[s._v("多租户网络环境隔离")])]),s._v(" "),a("h4",{attrs:{id:"网络访问控制-网络策略概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络访问控制-网络策略概述"}},[s._v("#")]),s._v(" 网络访问控制：网络策略概述")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("podSelector：")])]),s._v("  目标Pod，根据标签选择。")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("policyTypes：")])]),s._v("  策略类型，指定策略用于入站、出站流量。")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Ingress：")])]),s._v("  from是可以访问的白名单，可以来自于IP段、命名空间、 Pod标签等，ports是可以访问的端口。")]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Egress：")])]),s._v("  这个Pod组可以访问外部的IP段和端口。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("network"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.17.0.0/16\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("except")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 172.17.1.0/24\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("project")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myproject\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipBlock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.0.0.0/24\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5978")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("h3",{attrs:{id:"网络访问控制-网络策略概述-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络访问控制-网络策略概述-2"}},[s._v("#")]),s._v(" 网络访问控制：网络策略概述")]),s._v(" "),a("p",[s._v("网络策略工作流程：")]),s._v(" "),a("p",[s._v("1、创建Network Policy资源")]),s._v(" "),a("p",[s._v("2、Policy Controller监控网络策略，同步并通知节点上程序")]),s._v(" "),a("p",[s._v("3、节点上DaemonSet运行的程序从etcd中获取Policy，调用本 地Iptables创建防火墙规则")]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111556902.png",alt:"image-20220411155234458"}}),s._v(" "),a("h4",{attrs:{id:"网络访问控制案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络访问控制案例"}},[s._v("#")]),s._v(" 网络访问控制案例")]),s._v(" "),a("ol",[a("li",[s._v("案例1：拒绝命名空间下所有Pod出入站流量")]),s._v(" "),a("li",[s._v("案例2：拒绝其他命名空间Pod访问")]),s._v(" "),a("li",[s._v("案例3：允许其他命名空间Pod访问指定应用")]),s._v(" "),a("li",[s._v("案例4：同一个命名空间下应用之间限制访问")]),s._v(" "),a("li",[s._v("案例5：只允许指定命名空间中的应用访问")])]),s._v(" "),a("h5",{attrs:{id:"拒绝命名空间下所有pod入、出站流量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#拒绝命名空间下所有pod入、出站流量"}},[s._v("#")]),s._v(" 拒绝命名空间下所有Pod入、出站流量")]),s._v(" "),a("p",[a("code",[s._v("需求：拒绝test命名空间下所有Pod入、出站流量")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配本命名空间所有pod")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ingress和egress没有指定规则，则不允许任何流量进出pod")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"拒绝其他命名空间pod访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#拒绝其他命名空间pod访问"}},[s._v("#")]),s._v(" 拒绝其他命名空间Pod访问")]),s._v(" "),a("p",[a("code",[s._v("需求：test命名空间下所有pod可以互相访问，也可以访问其他 命名空间Pod，但其他命名空间不能访问test命名空间Pod。")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deny"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("namespaces \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配本命名空间所有pod")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h5",{attrs:{id:"允许其他命名空间pod访问指定应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#允许其他命名空间pod访问指定应用"}},[s._v("#")]),s._v(" 允许其他命名空间Pod访问指定应用")]),s._v(" "),a("p",[a("code",[s._v("需求：允许其他命名空间访问test命名空间指定Pod")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" allow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("namespaces \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配所有命名空间的pod")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h5",{attrs:{id:"同一个命名空间下应用之间限制访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同一个命名空间下应用之间限制访问"}},[s._v("#")]),s._v(" 同一个命名空间下应用之间限制访问")]),s._v(" "),a("p",[a("code",[s._v("需求：将test命名空间中标签为run=web的pod隔离， 只允许标签为run=client1的pod访问80端口")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" client1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h5",{attrs:{id:"只允许指定命名空间中的应用访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#只允许指定命名空间中的应用访问"}},[s._v("#")]),s._v(" 只允许指定命名空间中的应用访问")]),s._v(" "),a("p",[a("code",[s._v("需求：限制dev命名空间标签为env=dev的pod，只允许 prod命名空间中的pod访问和其他所有命名空间 app=client1标签pod访问")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dev\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Ingress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 满足允许prod命名空间中的pod访问")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prod\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许pod标签为app=client1的pod访问，所有命名空间")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" client1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);