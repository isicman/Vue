(window.webpackJsonp=window.webpackJsonp||[]).push([[300],{780:function(s,a,t){"use strict";t.r(a);var n=t(19),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"ansible进阶"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible进阶"}},[s._v("#")]),s._v(" Ansible进阶")]),s._v(" "),t("h4",{attrs:{id:"掌握要点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#掌握要点"}},[s._v("#")]),s._v(" 掌握要点")]),s._v(" "),t("blockquote",[t("p",[s._v("（1）掌握 Ansible 中 includes 使用。")]),s._v(" "),t("p",[s._v("（2）掌握 Ansible 中 roles 的使用。")]),s._v(" "),t("p",[s._v("（3）掌握 Jinja2 实现模板自定义。")])]),s._v(" "),t("h4",{attrs:{id:"includes模块的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#includes模块的使用"}},[s._v("#")]),s._v(" includes模块的使用")]),s._v(" "),t("p",[s._v("include 简单用法在进行编程时，运维人员都会将可以重复利用的代码提取出来，将提取出的代码作为一个逻辑单元，这个逻辑单元通常被称为“函数”或者“方法”，函数可以让用户更加方便、重复地调用一段代码，并且如果需要更改这段代码的逻辑，只要更改函数本身即可，所有调用函数之处的逻辑都会随之改变。")]),s._v(" "),t("p",[s._v("在 Ansible 中，其实也有类似的功能，这种功能被称之为“include”，通过 include，运维人员可以在一个 PlayBook 中包含另一个文件，以便实现刚才所描述的效果，接下来就来了解一下 include 的用法。")]),s._v(" "),t("p",[s._v("先来看一个小示例，假设运维人员想要编写 2 个 PlayBook，这 2 个 PlayBook 分别用于安装 LAMP 和 LNMP 环境，2 个 PlayBook 的大致内容如下：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat lamp.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node1   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install mysql     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mysql state=present \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install php       \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=php"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("fpm state=present \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install httpd     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=present \n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat lnmp.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node1 \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install mysql     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mysql state=present \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install php       \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=php"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("fpm state=present \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install nginx     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=nginx state=present \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("blockquote",[t("p",[s._v("注意：")]),s._v(" "),t("p",[s._v("无论在 lamp.yaml 中还是在 lnmp.yaml 中，安装 MySQL 和 PHP 部分的任务是完全相同的，所以可以把这两个任务提取出来，作为一个逻辑单元。把安装 MySQL 和 PHP 部分的任务提取到 install_MysqlAndPhp.yaml 文件中，文件内容如下：")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat install_MysqlAndPhp.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install mysql   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mysql state=present \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install php   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=php"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("fpm state=present \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("如上例所示，2 个 task 被提取到了 install_MysqlAndPhp.yaml 文件中，当需要安装 MySQL 和 php-fpm 时，只需要调用此 YAML 文件即可。那么怎样调用这个文件呢？方法只要把 lamp.yaml 和 lnmp.yaml 修改为如下模样即可：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat lamp.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node1   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_MysqlAndPhp.yaml \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install httpd     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=present \n  \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat lnmp.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node1   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_MysqlAndPhp.yaml \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install nginx     \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=nginx state=present \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("blockquote",[t("p",[s._v("此处使用了 include 模块，引用了 install_MysqlAndPhp.yaml 文件，当引用此文件时，"),t("code",[s._v("install_MysqlAndPhp.yaml 文件中的 tasks 都会在被引用处执行")]),s._v("，这就是 include 的用法。include 模块可以指定一个文件，这个文件中的内容是一个任务列表（一个或多个任务），当使用 include 模块引用对应的文件时，文件中的任务会在被引用处执行，就好像写在被引用处一样。")])]),s._v(" "),t("h4",{attrs:{id:"include-tasks模块使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#include-tasks模块使用"}},[s._v("#")]),s._v(" include_tasks模块使用")]),s._v(" "),t("p",[s._v("include_tasks 模块。在理解了 include 以后，再来理解 include_tasks 就很简单了。众所周知，include 模块可以用来包含一个任务列表， include_tasks 模块的作用也是用来包含一个任务列表。在之后的版本中，如果想要包含一个任务列表，那么就可以使用 include_tasks 关键字代替 include 关键字。")]),s._v(" "),t("p",[s._v("示例如下：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat intest.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root \n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test task1"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include_tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" in.yaml \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test task2"')]),s._v("\n      \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat in.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test1 in in.yaml"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test2 in in.yaml"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("如上例所示，当需要包含一个任务列表时，include_tasks 关键字的用法与 include 完全相同，看看执行效果如何")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible-playbook intest.yaml ")]),s._v("\n\nPLAY "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("webserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *****************************************************************************************************\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Gathering Facts"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***********************************************************************************************\nok: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *********************************************************************************************************\nok: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test task1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("include_tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *************************************************************************************************\nincluded: /root/lnmp/test/in.yaml "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *********************************************************************************************************\nok: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test1 in in.yaml"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *********************************************************************************************************\nok: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test2 in in.yaml"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nTASK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" *********************************************************************************************************\nok: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msg"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test task2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nPLAY RECAP ***********************************************************************************************************\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6                "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("p",[s._v("如上面执行结果所示，当使用 include_tasks 时，include_tasks 本身会被当做一个 task，这个 task 会把被 include 的文件的路径输出在控制台中（即 included: /root/test/in.yaml for node1 这个语句），这就是 include_tasks 模块与 include 模块之间的区别之处。如果将上例中的 include_tasks 关键字替换成 include，控制台中则不会显示 included: /root/test/in.yaml for node1 信息，由此可见 include 是透明的，include_tasks 是可见的。include_tasks 更像是一个任务，这个任务包含了其他的一些任务。")]),s._v(" "),t("h4",{attrs:{id:"ansible-roles的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-roles的使用"}},[s._v("#")]),s._v(" Ansible roles的使用")]),s._v(" "),t("p",[s._v("⚫roles 使用场景 roles 适合大规模使用，PlayBook 如果文件较多时，不清楚哪些主机执行了哪些状态的 YAML 文件，roles 能清楚哪些主机应用哪些角色。")]),s._v(" "),t("p",[s._v("⚫下面使用一个小案例，来学习 roles 的使用。假如现在有 3 个被管理主机，第一个要配置成 httpd 服务器，第二个要配置成 PHP 服务器，第三个要配置成MySQL 服务器。如何来定义 PlayBook？若使用以前的方法，第一个 play 用到第一个主机上，用来构建 httpd，第二个 play 用到第二个主机上，用来构建 PHP，第三个 play 用到第三个主机上，用来构建 MySQL。这些 play 定义在 PlayBook 中比较麻烦，将来也不利于模块化调用和多次调用。比如，后期又加进来一个主机，这第 4 个主机既是 httpd 服务器，又是 PHP 服务器，这时只能写第 4 个 play，上面写安装 httpd 和 PHP。这样 PlayBook 中的代码就重复了。")]),s._v(" "),t("p",[s._v("⚫为了避免代码重复，roles 能够实现代码重复被调用。定义一个角色叫webserver，第二个角色叫 dbserver。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible anasible_playbook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat  role.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webserver \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver \n    \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dbserver \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" dbserver \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h4",{attrs:{id:"规划节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#规划节点"}},[s._v("#")]),s._v(" 规划节点")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[t("strong",[s._v("IP")])]),s._v(" "),t("th",[s._v("主机名")]),s._v(" "),t("th",[s._v("节点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("192.168.1.7")]),s._v(" "),t("td",[s._v("ansible")]),s._v(" "),t("td",[s._v("Ansible  节点")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.1.6")]),s._v(" "),t("td",[s._v("node1")]),s._v(" "),t("td",[s._v("Node1  节点")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.1.5")]),s._v(" "),t("td",[s._v("node2")]),s._v(" "),t("td",[s._v("Node2  节点")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.1.15")]),s._v(" "),t("td",[s._v("node3")]),s._v(" "),t("td",[s._v("Node3  节点")])])])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("ansible的hosts主机清单")])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ansible/hosts ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("webserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.6 \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("phpserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.5\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.15\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h5",{attrs:{id:"_1-创建roles文件夹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建roles文件夹"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.创建roles文件夹")])]),s._v(" "),t("p",[s._v("roles 实战准备使用 3 台主机，192.168.1.6 主机上安装 httpd，192.168.1.5 上安装 MySQL，192.168.1.15 上安装 MySQL 和 httpd。然后，建立两个角色 webserver 和 dbserver，并应用到这几个主机上。首先创建项目目录，在/opt 下创建项目目录 ansible_playbook，然后在 ansible_playbook 下创建 roles 下的必要目录。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -pv  /opt/ansible_playbook/roles/{webserver,dbserver}/{tasks,files,templates,meta,handlers,vars} ")]),s._v("\nmkdir: created directory ‘/opt/ansible_playbook’ \nmkdir: created directory ‘/opt/ansible_playbook/roles’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/tasks’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/files’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/templates’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/meta’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/handlers’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/webserver/vars’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/tasks’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/files’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/templates’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/meta’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/handlers’ \nmkdir: created directory ‘/opt/ansible_playbook/roles/dbserver/vars’ \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h5",{attrs:{id:"_2-查看文件目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-查看文件目录"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.查看文件目录")])]),s._v(" "),t("p",[s._v("⚫安装 tree 工具，Ansible 节点配置好域名后，使用网络 Yum 源自行下载 tree工具")]),s._v(" "),t("p",[s._v("⚫创建目录和安装完 tree 工具之后，查看 ansible_playbook 中的目录结构")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install tree -y ")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible opt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tree ansible_playbook/ ansible_playbook/ ")]),s._v("\n└── roles \n    ├── dbserver     │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    └── webserver \n        ├── files \n        ├── handlers \n        ├── meta \n        ├── tasks \n        ├── templates \n        └── vars \n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" directories, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" files \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("可以看见在每个 roles 下，又创建了好多目录，下面详细讲一下每个目录的作用：")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("files 目录：")]),s._v("角色可能会用到的一些其他文件可以放置在此目录中，比如，当定义 Nginx 角色时，需要配置 https，那么相关的证书文件即可放置在此目录中。")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("handlers目录：")]),s._v("当角色需要调用handlers时，默认会在此目录中的main.yaml 文件中查找对应的 handler。")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("meta 目录：")]),s._v("如果想要赋予这个角色一些元数据，则可以将元数据写入到 meta/main.yaml 文件中，这些元数据用于描述角色的相关属性。比如作者信息、角色主要作用等等，也可以在 meta/main.yml 文件中定义这个角色依赖于哪些其他角色，或者改变角色的默认调用设定。")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("tasks 目录：")]),s._v("角色需要执行的主任务文件放置在此目录中，默认的主任务文件名为 main.yaml。当调用角色时，默认会执行 main.yaml 文件中的任务，也可以将其他需要执行的任务文件通过 include 的方式包含在 tasks/main.yaml 文件中。")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("templates 目录：")]),s._v("角色相关的模板文件可以放置在此目录中。当使用角色相关的模板时，如果没有指定路径，会默认从此目录中查找对应名称的模板文件。")]),s._v(" "),t("p",[s._v("⚫"),t("code",[s._v("vars 目录：")]),s._v("角色会使用到的变量可以写入到此目录中的 main.yml 文件中，那 vars/main.yaml 文件和 defaults/main.yaml 文件的区别在哪里呢？区别就是， defaults/main.yaml 文件中变量的优先级是最低的，而 vars/main.yaml 文件中变量的优先级非常高。如果用户只是想提供一个默认的配置，那么可以把对应的变量定义在 defaults/main.yaml 中；如果用户想要确保别人在调用角色时，使用的值就是自己指定的值，则可以将变量定义在 vars/main.yaml 中。因为定义在 vars/main.yaml 文件中的变量的优先级非常高，所以其值比较难以覆盖。")]),s._v(" "),t("h5",{attrs:{id:"_3-配置角色-webserver"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置角色-webserver"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.配置角色 webserver")])]),s._v(" "),t("p",[s._v("⚫在 Ansible 节点，首先进入/opt/ansible_playbook/roles/webserver/files/目录")]),s._v(" "),t("p",[s._v("⚫在 files 目录下创建 httpd.conf 文件")]),s._v(" "),t("p",[s._v("⚫静态文件都放在 files 目录下。如果打算用模板文件，则应该把模板文件放在 templates 目录下。")]),s._v(" "),t("p",[s._v("⚫然后编写任务列表 tasks，安装httpd服务，中途修改配置文件触发handlers")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible opt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd ansible_playbook/roles/webserver/files/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# touch httpd.conf ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd ../tasks ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install httpd package \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=present \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install configuration file \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("copy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src=httpd.conf dest=/opt/httpd.conf \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" conf \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" restart httpd \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start httpd \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=started \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("⚫由于上面的 tasks 中定义了 notify，所以要定义 handlers。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd .. ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible webserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi handlers/main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible webserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat handlers/main.yaml  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restart httpd   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=restarted \n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h5",{attrs:{id:"_4-配置角色-dbserver"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-配置角色-dbserver"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.配置角色 dbserver")])]),s._v(" "),t("p",[s._v("⚫进入 dbserver 角色目录，将数据库配置文件 my.cnf 上传至 files 目录下")]),s._v(" "),t("p",[s._v("⚫编写任务列表 tasks，安装mariadb-server，中途替换配置文件，触发handlers。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible roles"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd dbserver/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls ")]),s._v("\nfiles  handlers  meta  tasks  templates  vars \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd files/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# touch my.cnf ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd .. ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi tasks/main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_mariadb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mariadb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server state=present \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install configuration file \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("copy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src=my.cnf dest=/opt/my.cnf \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" conf \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" restart mariadb \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start mariadb \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mariadb enabled=yes  state=started \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("⚫如果同样定义了 notify，需要定义 handlers。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi handlers/main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible dbserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat handlers/main.yaml  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restart mariadb   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=mariadb state=restarted \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h5",{attrs:{id:"_5-配置role的playbook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-配置role的playbook"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.配置role的playbook")])]),s._v(" "),t("p",[s._v("⚫配置 PlayBook 需要在 roles 目录同级创建 PlayBook。")]),s._v(" "),t("p",[s._v("⚫编排包含两个role，一个是webserver的一个是dbserver，也可以单独两个role写开，再两role个写一起。分别执行。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ansible_playbook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi role.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webserver \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dbserver \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" dbserver \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h5",{attrs:{id:"_6-执行playbook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-执行playbook"}},[s._v("#")]),s._v(" "),t("strong",[s._v("6.执行playbook")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ansible_playbooks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible-playbook role.yaml")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"ansible-jinja2的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-jinja2的使用"}},[s._v("#")]),s._v(" Ansible Jinja2的使用")]),s._v(" "),t("p",[s._v("**Jinja2 是一个现代的、设计者友好的、仿照 Django 模板的 Python 模板语言。**它速度快，被广泛使用，并且提供了可选的沙箱模板，执行环境保证安全。")]),s._v(" "),t("p",[s._v("**Ansible 使用 Jinja2 模板，也就是 template 模块。**该模块和 copy 模块一样，都是将文件复制到目标机器，但是区别在于 template 模块可以获取要复制文件中的变量的值，而 copy 模块则是原封不动地把文件内容复制过去。实际运用时，针对不同的主机定义不同的变量，template 会在文件分发前读取变量到 Jinja2 模板，之后再分发到不同的被管理主机上。")]),s._v(" "),t("p",[s._v("下面来看一个 Jinja2 模板使用的案例。假如为 2 台 webserver 安装 httpd 服务，而它们的配置文件，第一台节点上的 httpd 需要监听 80 端口，第二台节点上需要监听 8080 端口，两个节点的 ServerName 也是不一样的，所以就需要 2 个配置文件，这样管理起来极为不便。在这种情况下，可以考虑在配置文件中使用变量来定义。")]),s._v(" "),t("h5",{attrs:{id:"_1-修改tasks"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改tasks"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.修改tasks")])]),s._v(" "),t("p",[s._v("⚫修改webserver角色的清单列表。")]),s._v(" "),t("p",[s._v("⚫进入 Ansible 节点的/opt/ansible_playbook 目录下，修改 roles/webserver/tasks/main.yaml 文件")]),s._v(" "),t("p",[s._v("⚫将原来的 copy 模块替换成 template 模块，将 httpd.conf 改成 httpd.conf.j2。然后将提供的 httpd.conf.j2 文件放到在 roles/webserver/templates/目录下")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install httpd package \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=present \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install configuration file \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#注意这里的j2文件")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" conf \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" restart httpd \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start httpd \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=started \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ansible_playbook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd roles/webserver/templates/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible templates"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll total 4 ")]),s._v("\n-rw-r--r--. "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v(" Aug "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 02:20 httpd.conf.j2 \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible templates"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat httpd.conf.j2  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". \nListen "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#j2 文件中主要修改了该行 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". \nServerName "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ansible_fqdn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这是主机报告中的信息，直接使用 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h5",{attrs:{id:"_2-添加变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加变量"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.添加变量")])]),s._v(" "),t("p",[s._v("⚫在vars/下添加main.yaml文件。")]),s._v(" "),t("p",[s._v("⚫添加http_port: 88的变量。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible webserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd vars/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible vars"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http_port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#或者使用如下方法添加变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[root@ansible ~]# cat /etc/ansible/hosts  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[hosts]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#192.168.1.6 http_port=80")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#192.168.1.5 http_port=81")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#192.168.1.15 http_port=82")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h5",{attrs:{id:"_3-执行role"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-执行role"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.执行role")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible ansible_playbooks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible-playbook role.yaml")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);