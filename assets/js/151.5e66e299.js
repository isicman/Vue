(window.webpackJsonp=window.webpackJsonp||[]).push([[151],{631:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"kubernetes集群维护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes集群维护"}},[s._v("#")]),s._v(" Kubernetes集群维护")]),s._v(" "),a("h2",{attrs:{id:"etcd数据备份与恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etcd数据备份与恢复"}},[s._v("#")]),s._v(" Etcd数据备份与恢复")]),s._v(" "),a("p",[a("strong",[s._v("kubernetes使用Etcd数据库实时存储集群中的数据，安全起见，一定要备份。")])]),s._v(" "),a("h3",{attrs:{id:"安装etcd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装etcd"}},[s._v("#")]),s._v(" 安装etcd")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y etcd ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etcdctl --version ")]),s._v("\netcdctl version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.3")]),s._v(".11\nAPI version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"备份etcd数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份etcd数据库"}},[s._v("#")]),s._v(" 备份etcd数据库")]),s._v(" "),a("p",[a("strong",[s._v("如果工具版本是3默认API版本是2就要换成3版本")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl \\")]),s._v("\nsnapshot save snap.db "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份，指定一个文件名，在线进行备份")]),s._v("\n--endpoints"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://127.0.0.1:2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#连接ETCD的节点  使用ss -ntpl |grep 2379,需要查看网络插件是否使用宿主机的，访问带上ca证书校验")]),s._v("\n--cacert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定证书的公共目录下的etcd目录的ca.crt ")]),s._v("\n--cert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v(" \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定数字证书")]),s._v("\n--key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.key  \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定密钥")]),s._v("\n\nSnapshot saved at snap.db\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# du -sh snap.db \t\t\t\t#查看大小")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".2M    snap.db\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"删除数据deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除数据deployment"}},[s._v("#")]),s._v(" 删除数据deployment")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get deployment ")]),s._v("\nNAME   READY   UP-TO-DATE   AVAILABLE   AGE\nweb    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           161m\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete deployment web ")]),s._v("\ndeployment.apps "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web"')]),s._v(" deleted\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get deployment ")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" default namespace.\n\n\n可以看到当前是没有deployment的\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"恢复数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复数据"}},[s._v("#")]),s._v(" 恢复数据")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("先暂停kube-apiserver和etcd容器")])]),s._v(" "),a("li",[a("strong",[s._v("相当于把之前的文件夹换个名字做备份测试")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /var/lib/etcd/ /var/lib/etcd.back ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[s._v("#")]),s._v(" 恢复")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl snapshot restore snap.db --data-dir=/var/lib/etcd")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-11-08 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":46:35.934598 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mvcc: restore compact to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19609")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-11-08 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":46:35.941164 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/membership: added member 8e9e05c52164694d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("http://localhost:2380"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" to cluster cdf818194e3a8c32\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /etc/kubernetes/manifests.bak/ /etc/kubernetes/manifests")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart kubelet ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"查看数据恢复情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看数据恢复情况"}},[s._v("#")]),s._v(" 查看数据恢复情况")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("这里需要稍等一会，然后等待Pods重新构建起来")])]),s._v(" "),a("li",[a("strong",[s._v("查看deployment是否存在之前的数据")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -A ")]),s._v("\nNAMESPACE       NAME                                       READY   STATUS    RESTARTS   AGE\ndefault         web-96d5df5c8-w2vvf                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          172m\ningress-nginx   nginx-ingress-controller-gvfvl             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h29m\nkube-system     calico-kube-controllers-659bd7879c-qv5qx   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("          4h2m\nkube-system     calico-node-df8kn                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\nkube-system     calico-node-xrmnz                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h57m\nkube-system     client3                                    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          79m\nkube-system     coredns-7f89b7bc75-jwxfg                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\nkube-system     coredns-7f89b7bc75-qf8dg                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\nkube-system     etcd-master                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\nkube-system     kube-apiserver-master                      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\nkube-system     kube-controller-manager-master             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h\nkube-system     kube-proxy-mbhtv                           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          4h2m\nkube-system     kube-proxy-n8qc8                           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h57m\nkube-system     kube-scheduler-master                      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4h2m\n\nroot@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get deployment ")]),s._v("\nNAME   READY   UP-TO-DATE   AVAILABLE   AGE\nweb    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           172m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h2",{attrs:{id:"k8s集群版本升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s集群版本升级"}},[s._v("#")]),s._v(" K8S集群版本升级")]),s._v(" "),a("p",[a("strong",[s._v("Kubernetes每隔3个月发布一个小版本。")])]),s._v(" "),a("h3",{attrs:{id:"升级策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级策略"}},[s._v("#")]),s._v(" 升级策略：")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("始终保持最新")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("每半年升级一次，这样会落后社区1-2个版本")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("一年升级一次，或者更长，落后版本太多")])])])]),s._v(" "),a("h3",{attrs:{id:"升级的基本流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级的基本流程"}},[s._v("#")]),s._v(" 升级的基本流程")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("升级管理节点  >  升级其他管理节点  >  升级工作节点")])])]),s._v(" "),a("h3",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" 注意事项：")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("升级之前必须备份所有组件以及数据，例如etcd")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("千万不要跨多个小版本进行升级，例如从1.16-1.19")])])])]),s._v(" "),a("blockquote",[a("h3",{attrs:{id:"kubeadm对k8s集群进行版本升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubeadm对k8s集群进行版本升级"}},[s._v("#")]),s._v(" Kubeadm对K8S集群进行版本升级")])]),s._v(" "),a("h3",{attrs:{id:"升级管理节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级管理节点"}},[s._v("#")]),s._v(" 升级管理节点")]),s._v(" "),a("h4",{attrs:{id:"查找最新版本号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查找最新版本号"}},[s._v("#")]),s._v(" 查找最新版本号：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum list --showduplicates kubeadm ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"升级kubeadm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级kubeadm"}},[s._v("#")]),s._v(" 升级kubeadm：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y kubeadm-1.20.1-0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"驱逐node上的pod-且不可调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#驱逐node上的pod-且不可调度"}},[s._v("#")]),s._v(" 驱逐node上的Pod，且不可调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl drain master ")]),s._v("\nnode/master cordoned\nerror: unable to drain "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"master"')]),s._v(", aborting command"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nThere are pending nodes to be drained:\n master\nerror: cannot delete DaemonSet-managed Pods "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("use --ignore-daemonsets to ignore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": kube-system/calico-node-df8kn, kube-system/kube-proxy-mbhtv\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl drain master --ignore-daemonsets")]),s._v("\nnode/master already cordoned\nnode/master evicted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"检查集群是否可以升级-并且获取可以升级的版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查集群是否可以升级-并且获取可以升级的版本"}},[s._v("#")]),s._v(" 检查集群是否可以升级，并且获取可以升级的版本：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm upgrade plan ")]),s._v("\n···\nYou can now apply the upgrade by executing the following command:\n\n        kubeadm upgrade apply v1.20.12    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将会提示你更新到可用的最新版本")]),s._v("\n\nNote: Before you can perform this upgrade, you have to update kubeadm to v1.20.12.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"执行升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行升级"}},[s._v("#")]),s._v(" 执行升级：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm upgrade apply v1.20.1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Making sure the configuration is correct:\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Reading configuration from the cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" FYI: You can "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("look")]),s._v(" at this config "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl -n kube-system get cm kubeadm-config -o yaml'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running cluster health checks\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" You have chosen to change the cluster version to "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1.20.1"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/versions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Cluster version: v1.20.0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/versions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" kubeadm version: v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/confirm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Are you sure you want to proceed with the upgrade? "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("y/N"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": y\n···\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/successful"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" SUCCESS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Your cluster was upgraded to "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1.20.1"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" Enjoy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("upgrade/kubelet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Now that your control plane is upgraded, please proceed with upgrading your kubelets "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" you haven't already "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" so.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h4",{attrs:{id:"取消不可调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#取消不可调度"}},[s._v("#")]),s._v(" 取消不可调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS                     ROLES                  AGE     VERSION\nmaster   Ready,SchedulingDisabled   control-plane,master   4h45m   v1.20.0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 4h40m   v1.20.0\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl uncordon master ")]),s._v("\nnode/master uncordoned\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"升级kubelet和kubectl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级kubelet和kubectl"}},[s._v("#")]),s._v(" 升级kubelet和kubectl：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y kubectl-1.20.1-0 kubelet-1.20.1-0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"重启kubelet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重启kubelet"}},[s._v("#")]),s._v(" 重启kubelet：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl daemon-reload ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart kubelet ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS   ROLES                  AGE     VERSION\nmaster   Ready    control-plane,master   4h49m   v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 4h44m   v1.20.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"升级工作节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级工作节点"}},[s._v("#")]),s._v(" 升级工作节点")]),s._v(" "),a("h4",{attrs:{id:"升级kubeadm-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级kubeadm-2"}},[s._v("#")]),s._v(" 升级kubeadm：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y kubeadm-1.20.1-0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"驱逐node上的pod-且不可调度-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#驱逐node上的pod-且不可调度-2"}},[s._v("#")]),s._v(" 驱逐node上的Pod，且不可调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl drain node --ignore-daemonsets --force")]),s._v("\nnode/node already cordoned\nnode/node evicted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"升级kubelet配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级kubelet配置"}},[s._v("#")]),s._v(" 升级kubelet配置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm upgrade node ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"升级kubelet和kubectl-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级kubelet和kubectl-2"}},[s._v("#")]),s._v(" 升级kubelet和kubectl:")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y kubectl=1.20.1-0 kubelet-1.20.1-0 ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"重启kubelet-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重启kubelet-2"}},[s._v("#")]),s._v(" 重启kubelet：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl daemon-reload ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart kubelet ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"取消不可调度-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#取消不可调度-2"}},[s._v("#")]),s._v(" 取消不可调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS                     ROLES                  AGE     VERSION\nmaster   Ready                      control-plane,master   4h59m   v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready,SchedulingDisabled   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 4h54m   v1.20.1\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl uncordon node")]),s._v("\nnode/node uncordoned\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS   ROLES                  AGE     VERSION\nmaster   Ready    control-plane,master   4h59m   v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 4h54m   v1.20.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"k8s集群节点正确下线流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s集群节点正确下线流程"}},[s._v("#")]),s._v(" K8s集群节点正确下线流程")]),s._v(" "),a("p",[s._v("如果你想维护或者删除某个节点，正确流程如下：")]),s._v(" "),a("h4",{attrs:{id:"获取节点列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取节点列表"}},[s._v("#")]),s._v(" 获取节点列表：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS   ROLES                  AGE     VERSION\nmaster   Ready    control-plane,master   5h3m    v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 4h57m   v1.20.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"设置不可调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置不可调度"}},[s._v("#")]),s._v(" 设置不可调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl cordon node ")]),s._v("\nnode/node cordoned\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"驱逐节点上的pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#驱逐节点上的pod"}},[s._v("#")]),s._v(" 驱逐节点上的Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl drain node --ignore-daemonsets")]),s._v("\nnode/node already cordoned\nnode/node evicted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"移除节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移除节点"}},[s._v("#")]),s._v(" 移除节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete node node ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(" deleted\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get node ")]),s._v("\nNAME     STATUS   ROLES                  AGE    VERSION\nmaster   Ready    control-plane,master   5h4m   v1.20.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"重新加入节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重新加入节点"}},[s._v("#")]),s._v(" 重新加入节点")]),s._v(" "),a("h4",{attrs:{id:"使用kubeadm重置节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用kubeadm重置节点"}},[s._v("#")]),s._v(" 使用kubeadm重置节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm reset ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("reset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" WARNING: Changes made to this "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" by "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubeadm init'")]),s._v(" or "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubeadm join'")]),s._v(" will be reverted.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("reset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Are you sure you want to proceed? "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("y/N"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": y\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"在master节点生成新的token"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在master节点生成新的token"}},[s._v("#")]),s._v(" 在master节点生成新的token：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm  token create  ")]),s._v("\nmmvxlw.lgpb891ml8g7q9oq\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'")]),s._v("\n0026319b035eef72f40ba1545358f75113756c7b97e9925f4dd3105a01fbdb01\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"node重新加入节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node重新加入节点"}},[s._v("#")]),s._v(" node重新加入节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm join 192.168.1.18:6443 --token mmvxlw.lgpb891ml8g7q9oq --discovery-token-ca-cert-hash sha256:0026319b035eef72f40ba1545358f75113756c7b97e9925f4dd3105a01fbdb01")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING SystemVerification"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": this Docker version is not on the list of validated versions: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.10")]),s._v(".10. Latest validated version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19.03")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Reading configuration from the cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" FYI: You can "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("look")]),s._v(" at this config "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl -n kube-system get cm kubeadm-config -o yaml'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet configuration to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/config.yaml"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet environment "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with flags to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/kubeadm-flags.env"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting the kubelet\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the kubelet to perform the TLS Bootstrap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nThis "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl get nodes'")]),s._v(" on the control-plane to see this "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" the cluster.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"查看节点列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看节点列表"}},[s._v("#")]),s._v(" 查看节点列表：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes ")]),s._v("\nNAME     STATUS   ROLES                  AGE     VERSION\nmaster   Ready    control-plane,master   5h13m   v1.20.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("     Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                 32s     v1.20.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);