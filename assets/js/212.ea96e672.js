(window.webpackJsonp=window.webpackJsonp||[]).push([[212],{692:function(s,t,a){"use strict";a.r(t);var e=a(19),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"ceph对接opensstack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ceph对接opensstack"}},[s._v("#")]),s._v(" Ceph对接OpensStack")]),s._v(" "),a("h3",{attrs:{id:"简要"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简要"}},[s._v("#")]),s._v(" 简要")]),s._v(" "),a("p",[s._v("Openstack环境中，数据存储可分为临时性存储与永久性存储。")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("临时性存储：")]),s._v("  主要由本地文件系统提供，并主要用于nova虚拟机的本地系统与临时数据盘，以及存储glance上传的系统镜像；")]),s._v(" "),a("li",[a("strong",[s._v("永久性存储：")]),s._v("  主要由cinder提供的块存储与swift提供的对象存储构成，以cinder提供的块存储应用最为广泛，块存储通常以云盘的形式挂载到虚拟机中使用。")])]),s._v(" "),a("p",[s._v("Openstack中需要进行数据存储的三大项目主要是nova项目（虚拟机镜像文件），glance项目（共用模版镜像）与cinder项目（块存储）。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("下图为 "),a("strong",[s._v("cinder，glance与nova访问ceph")]),s._v(" 集群的逻辑图：")])]),s._v(" "),a("li",[a("p",[s._v("ceph与openstack集成主要用到ceph的rbd服务，ceph底层为rados存储集群，ceph通过librados库实现对底层rados的访问；")])]),s._v(" "),a("li",[a("p",[s._v("openstack各项目客户端调用librbd，再由librbd调用librados访问底层rados；\n实际使用中，nova需要使用libvirtdriver驱动以通过libvirt与qemu调用librbd；cinder与glance可直接调用librbd；")])]),s._v(" "),a("li",[a("p",[s._v("写入ceph集群的数据被条带切分成多个object，object通过hash函数映射到pg（构成pg容器池pool），然后pg通过几圈crush算法近似均匀地映射到物理存储设备osd（osd是基于文件系统的物理存储设备，如xfs，ext4等）。")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108433.webp",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"节点规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点规划"}},[s._v("#")]),s._v(" 节点规划")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("操作系统")]),s._v(" "),a("th",[s._v("IP地址")]),s._v(" "),a("th",[s._v("主机名称")]),s._v(" "),a("th",[s._v("节点")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("CentOS-7.9")]),s._v(" "),a("td",[s._v("172.25.254.128")]),s._v(" "),a("td",[s._v("controller")]),s._v(" "),a("td",[s._v("控制节点+计算节点")])]),s._v(" "),a("tr",[a("td",[s._v("CentOS-7.9")]),s._v(" "),a("td",[s._v("172.25.254.129")]),s._v(" "),a("td",[s._v("compute")]),s._v(" "),a("td",[s._v("计算节点")])]),s._v(" "),a("tr",[a("td",[s._v("CentOS-7.9")]),s._v(" "),a("td",[s._v("172.25.254.130")]),s._v(" "),a("td",[s._v("ceph01      500GX3 硬盘")]),s._v(" "),a("td",[s._v("OSD/MON/Prometheus+Grafana节点")])]),s._v(" "),a("tr",[a("td",[s._v("CentOS-7.9")]),s._v(" "),a("td",[s._v("172.25.254.131")]),s._v(" "),a("td",[s._v("ceph02      500GX3 硬盘")]),s._v(" "),a("td",[s._v("OSD节点")])]),s._v(" "),a("tr",[a("td",[s._v("CentOS-7.9")]),s._v(" "),a("td",[s._v("172.25.254.132")]),s._v(" "),a("td",[s._v("ceph03      500GX3 硬盘")]),s._v(" "),a("td",[s._v("OSD节点")])])])]),s._v(" "),a("blockquote",[a("p",[s._v("使用搭建好的双节点 "),a("strong",[s._v("OpenStack-T")]),s._v(" 版本云平台。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108785.png",alt:"image-20220305200205759"}})]),s._v(" "),a("h3",{attrs:{id:"部署ceph集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署ceph集群"}},[s._v("#")]),s._v(" 部署Ceph集群")]),s._v(" "),a("p",[s._v("这里使用Ceph-Deploy的方式部署集群，生产环境中不推荐使用该方式。可以通过Ansible的或等方式部署。")]),s._v(" "),a("p",[s._v("需要配置hosts、关闭防火墙以及selinux的设置、优化内核参数、使用制作好的Ceph-14.2.22的离线源。  "),a("strong",[s._v("（以上操作在所有节点进行）")])]),s._v(" "),a("h5",{attrs:{id:"🏷️配置本地的host"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置本地的host"}},[s._v("#")]),s._v(" 🏷️配置本地的host")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/hosts ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6 \n\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.130 ceph01 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.131 ceph02 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.132 ceph03 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.128 controller \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.129 compute \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h5",{attrs:{id:"🏷️关闭防火墙"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️关闭防火墙"}},[s._v("#")]),s._v(" 🏷️关闭防火墙")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl stop firewalld ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's/enforcing/disabled/' /etc/selinux/config")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# setenforce 0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"🏷️优化内核参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️优化内核参数"}},[s._v("#")]),s._v(" 🏷️优化内核参数")]),s._v(" "),a("p",[s._v("内核参数优化、read_ahead,通过数据预读并且记载到随机访问内存方式提高磁盘读操作。")]),s._v(" "),a("p",[s._v("设置I/O Scheduler，SSD要用noop，SATA/SAS使用deadline。")]),s._v(" "),a("p",[s._v("设置 /etc/security/limits.conf和设置 /etc/security/limits.d/20-nproc.conf。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat >> /etc/sysctl.conf << EOF")]),s._v("\nkernel.pid_max "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194303")]),s._v("\nvm.swappiness "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nEOF\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl -p")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "8192" > /sys/block/sda/queue/read_ahead_kb')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "deadline" >/sys/block/sd[x]/queue/scheduler')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "noop" >/sys/block/sd[x]/queue/scheduler')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/security/limits.conf ")]),s._v("\nEnd of "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n*\thard nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n*\tsoft nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n*\thard nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n*\tsoft nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n*\tsoft core "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n*\thard core "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/security/limits.d/20-nproc.conf")]),s._v("\n*\tsoft nproc unlimitedroot soft nproc unlimited\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h5",{attrs:{id:"🏷️配置本地离线源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置本地离线源"}},[s._v("#")]),s._v(" 🏷️配置本地离线源")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/yum.repos.d/local.repo ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ceph\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("baseurl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://172.25.254.133/file/repo/ceph-n/\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gpgcheck")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"🏷️对所有节点配置免密"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️对所有节点配置免密"}},[s._v("#")]),s._v(" 🏷️对所有节点配置免密")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id ceph01")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id ceph02")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id ceph03")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id controller")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id compute")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"🏷️安装ceph软件包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️安装ceph软件包"}},[s._v("#")]),s._v(" 🏷️安装Ceph软件包")]),s._v(" "),a("p",[s._v("集成过程中，需要在 OpenStack 的 controller 节点和 compute 节点安装 Ceph 软件包，作为 Ceph 客户端。")]),s._v(" "),a("p",[a("strong",[s._v("在ceph01节点上安装软件包")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y ceph-deploy ceph ceph-mds ceph-radosgw ceph-mgr-dashboard")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("在ceph02、ceph03节点上安装软件包")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph02 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install ceph ceph-mds ceph-radosgw ceph-mgr-dashboard")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph03 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install ceph ceph-mds ceph-radosgw ceph-mgr-dashboard")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("在controller、compute安装ceph软件包")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y  ceph ceph-radosgw ceph-common ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"🏷️初始化配置mon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️初始化配置mon"}},[s._v("#")]),s._v(" 🏷️初始化配置mon")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在Ceph01控制节点操作")])])]),s._v(" "),a("p",[s._v("初始化Ceph集群三个节点。")]),s._v(" "),a("p",[s._v("修改/etc/ceph-cluster/ceph.conf，添加配置文件。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/ceph/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph-deploy new ceph01 ceph02 ceph03 --cluster-network 172.25.254.0/24 --public-network 172.25.254.0/24")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat ceph.conf ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("global"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nfsid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 52dc97f5-e311-43e9-b307-0e94c83dfd87\npublic_network "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.0/24\ncluster_network "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.0/24\nmon_initial_members "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ceph01, ceph02, ceph03\nmon_host "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.130,172.25.254.131,172.25.254.132\nauth_cluster_required "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cephx\nauth_service_required "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cephx\nauth_client_required "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cephx\nauth_allow_insecure_global_id_reclaim "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("  \nmon_clock_drift_allowed "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("    \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mon.ceph01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ceph01 \n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mon_addr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.130 \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mon.ceph02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ceph02\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mon_addr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.131\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mon.ceph03"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ceph03\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mon_addr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.25")]),s._v(".254.132 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h5",{attrs:{id:"🏷️初始化mon节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️初始化mon节点"}},[s._v("#")]),s._v(" 🏷️初始化mon节点")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在Ceph01控制节点操作")])])]),s._v(" "),a("p",[s._v("将 keyring 同步到各节点，以便其它节点可以执行 ceph 集群管理命令。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph-deploy mon create-initial ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph-deploy --overwrite-conf admin ceph01 ceph02 ceph03 controller compute")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"🏷️初始化配置mgr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️初始化配置mgr"}},[s._v("#")]),s._v(" 🏷️初始化配置mgr")]),s._v(" "),a("p",[s._v("ceph-mgr 进程是主备模式，同一时刻只有一个节点工作，其他节点处于 standby。")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在Ceph01控制节点操作")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph-deploy mgr create ceph01 ceph02 ceph03")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -s ")]),s._v("\n  cluster:\n    id:     6fa8bcf8-bb73-48ff-b96d-621298b3be0f\n    health: HEALTH_OK\n \n  services:\n    mon: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" daemons, quorum ceph01,ceph02,ceph03 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 60m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: ceph01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active, since 51m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", standbys: ceph02, ceph03\n    osd: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" osds: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" up "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 55m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 55m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n  data:\n    pools:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" pools, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" pgs\n    objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" objects, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" MiB\n    usage:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" GiB used, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.4")]),s._v(" TiB / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.4")]),s._v(" TiB avail\n    pgs:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" active+clean\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h5",{attrs:{id:"🏷️初始化配置osd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️初始化配置osd"}},[s._v("#")]),s._v(" 🏷️初始化配置osd")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在Ceph01控制节点操作")])])]),s._v(" "),a("p",[s._v("按照规划每个节点有 3 个 OSD。一共可以划分9个OSD。")]),s._v(" "),a("p",[s._v("擦除集群节点上用来用作OSD设备的磁盘(disk zap)，生产环境下可以单独指定block-db和block-wal设备以优化性能。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for dev in /dev/sdb /dev/sdc /dev/sdd")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy disk zap ceph01 "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy osd create ceph01 --bluestore --data "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy disk zap ceph02 "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy osd create ceph02 --bluestore --data "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy disk zap ceph03 "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-deploy osd create ceph0 --bluestore --data "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$dev")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsblk  ")]),s._v("\nNAME                                                                                                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda                                                                                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":0    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" disk \n└─sda1                                                                                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":1    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" part /\nsdb                                                                                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":16   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" disk \n└─ceph--1914cd94--70ca--4c2e--beef--5745262bdef5-osd--block--073aabcf--fbfc--4c95--b8e5--e038ef01b6de "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("253")]),s._v(":0    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" lvm  \nsdc                                                                                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":32   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" disk \n└─ceph--b9ae593e--bf08--400e--b832--09bac1a60b2e-osd--block--17c3c65e--15aa--4f90--8eed--65194a1e79bf "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("253")]),s._v(":1    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" lvm  \nsdd                                                                                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(":48   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" disk \n└─ceph--44b0586e--820e--4c51--8301--4b63b6f4b228-osd--block--d8500bfb--2383--4caf--97fb--f39695b1de7d "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("253")]),s._v(":2    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  500G  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" lvm  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h5",{attrs:{id:"🏷️开启dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️开启dashboard"}},[s._v("#")]),s._v(" 🏷️开启Dashboard")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在Ceph01控制节点操作")])])]),s._v(" "),a("p",[s._v("查看Ceph版本，nautilus版及以后需要在所有运行mgr的节点安装ceph-mgr-dashboard。")]),s._v(" "),a("p",[s._v("启用或禁用MGR dashboard模块。")]),s._v(" "),a("p",[s._v("创建自签名证书或者禁用ssl。")]),s._v(" "),a("p",[s._v("设置MGR dashboard模块的ip和port(可选)。")]),s._v(" "),a("p",[s._v("设置登录认证。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mgr versions")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mgr module enable dashboard")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mgr module disable dashboard")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph dashboard create-self-signed-cert")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph config set mgr mgr/dashboard/ssl false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph config set mgr mgr/dashboard/server_addr 0.0.0.0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph config set mgr mgr/dashboard/server_port 8443")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "000000" > password.txt')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph dashboard ac-user-create admin -i password.txt administrator")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph dashboard ac-user-show admin")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出MGR模块提供的服务端点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mgr services")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://ceph01:8443/"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108555.png",alt:"image-20220306084356040"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108008.png",alt:"image-20220306002122345"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108315.png",alt:"image-20220305215422613"}})]),s._v(" "),a("h3",{attrs:{id:"集成openstack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集成openstack"}},[s._v("#")]),s._v(" 集成OpenStack")]),s._v(" "),a("p",[s._v("在之前已经安装了ceph的客户端，也覆盖传送了配置文件，所以可以查看当前的ceph集群状态。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -s ")]),s._v("\n  cluster:\n    id:     6fa8bcf8-bb73-48ff-b96d-621298b3be0f\n    health: HEALTH_OK\n \n  services:\n    mon: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" daemons, quorum ceph01,ceph02,ceph03 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 60m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: ceph01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active, since 51m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", standbys: ceph02, ceph03\n    osd: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" osds: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" up "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 55m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 55m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n  data:\n    pools:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" pools, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("352")]),s._v(" pgs\n    objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" objects, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" MiB\n    usage:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.2")]),s._v(" GiB used, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.4")]),s._v(" TiB / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.4")]),s._v(" TiB avail\n    pgs:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("352")]),s._v(" active+clean\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h5",{attrs:{id:"🏷️创建存储池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️创建存储池"}},[s._v("#")]),s._v(" 🏷️创建存储池")]),s._v(" "),a("p",[s._v("在ceph01上创建所需的存储池，根据实际OSD数量修改PG数目。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  ceph osd pool create volumes 128")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  ceph osd pool create images 32")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  ceph osd pool create backups 32")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  ceph osd pool create vms 128")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd pool ls ")]),s._v("\nvolumes\nimages\nbackups\nvms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h5",{attrs:{id:"🏷️ceph创建用户并授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️ceph创建用户并授权"}},[s._v("#")]),s._v(" 🏷️ceph创建用户并授权")]),s._v(" "),a("ol",[a("li",[s._v("在ceph01上为cinder、glance、cinder-backup用户创建密钥，允许其访问Ceph存储池创建用户client.cinder，对volumes存储池有rwx权限，对vms存储池有rwx权限，对images池有rx权限。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rx pool=images'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建用户 client.glance，对images存储池有rwx权限。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.glance mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=images'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("创建用户client.cinder-backup，对backups存储池有rwx权限。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder-backup mon 'profile rbd' osd 'profile rbd pool=backups'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("将glance的keyring 保存到 "),a("strong",[s._v("controller")]),s._v("（glance服务所在节点）上。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.glance | ssh controller tee /etc/ceph/ceph.client.glance.keyring")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh controller chown glance:glance /etc/ceph/ceph.client.glance.keyring")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("将cinder的keyring保存到**（控制节点、计算节点、存储节点服务所在节点）**上。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder | ssh controller tee /etc/ceph/ceph.client.cinder.keyring ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh controller chown cinder:cinder /etc/ceph/ceph.client.cinder.keyring")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder | ssh compute tee /etc/ceph/ceph.client.cinder.keyring ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh compute chown cinder:cinder /etc/ceph/ceph.client.cinder.keyring")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("将cinder-backup的keyring保存到（cinder-backup服务所在节点，此处是"),a("strong",[s._v("controller/compute")]),s._v("r）上。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder-backup | ssh controller tee /etc/ceph/ceph.client.cinder-backup.keyring ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh controller chown cinder:cinder /etc/ceph/ceph.client.cinder-backup.keyring ")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph auth get-or-create client.cinder-backup | ssh compute tee /etc/ceph/ceph.client.cinder-backup.keyring ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh compute chown cinder:cinder /etc/ceph/ceph.client.cinder-backup.keyring ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"🏷️添加密钥到libvirt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️添加密钥到libvirt"}},[s._v("#")]),s._v(" 🏷️添加密钥到libvirt")]),s._v(" "),a("p",[s._v("在计算节点**（compute）**上向 libvirt 添加秘钥，先在计算节点 "),a("strong",[s._v("compute")]),s._v("上操作，生成密钥。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  UUID=$(uuidgen)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  cd /etc/ceph")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  cat > secret.xml <<EOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("secret "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ephemeral")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("private")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("uuid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${UUID}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/uuid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("usage "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("client.cinder secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/usage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" \nEOF\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat secret.xml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("secret "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ephemeral")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("private")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("uuid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("8fc81390-ad91-4814-a35a-e5bf716f053"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v("<")]),s._v("/uuid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("usage "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("client.cinder secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/usage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/secret"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("添加密钥到 libvirt。")]),s._v(" "),a("blockquote",[a("p",[s._v("说明：保存此处生成的 UUID 的值，后面 Cinder 以及 Nova 的配置中需要用到，UUID 为：8fc81390-ad91-4814-a35a-e5bf716f0533 如果添加错误，需要删除，则执行如下命令")]),s._v(" "),a("p",[a("code",[s._v("# virsh secret-undefine 8fc81390-ad91-4814-a35a-e5bf716f0533")]),s._v(" 如果控制节点也当计算点用，则也要添加密钥。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-define --file secret.xml")]),s._v("\nSecret 8fc81390-ad91-4814-a35a-e5bf716f0533 created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-set-value --secret 8fc81390-ad91-4814-a35a-e5bf716f0533  --base64 $(cat /etc/ceph/ceph.client.cinder.keyring | grep key | awk -F ' ' '{ print $3 }')")]),s._v("\nSecret value "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看添加后的密钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-list ")]),s._v("\n UUID                                  Usage\n--------------------------------------------------------------------------------\n 8fc81390-ad91-4814-a35a-e5bf716f0533  ceph client.cinder secret\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("再将secret.xml拷贝到controller。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scp secret.xml controller:/etc/ceph/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/ceph/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# UUID=8fc81390-ad91-4814-a35a-e5bf716f0533 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  virsh secret-set-value --secret 8fc81390-ad91-4814-a35a-e5bf716f0533 --base64 $(cat /etc/ceph/ceph.client.cinder.keyring | grep key | awk -F ' ' '{ print $3 }')")]),s._v("\nSecret value "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-list ")]),s._v("\n UUID                                  Usage\n--------------------------------------------------------------------------------\n 8fc81390-ad91-4814-a35a-e5bf716f0533  ceph client.cinder secret\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"🏷️配置glance集成ceph"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置glance集成ceph"}},[s._v("#")]),s._v(" 🏷️配置Glance集成Ceph")]),s._v(" "),a("p",[s._v("在控制节点**（controller）**上修改 Glance 的配置文件。")]),s._v(" "),a("p",[s._v("镜像存储在 ceph 中会被分割成多个对象，单个对象大小，单位是 MB，该值最好是 2 的幂次方，默认是 8，chunk_size 不能太大，当镜像小于 chunk_size 时会上传失败。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/glance/glance-api.conf")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在[DEFAULT]部分添加如下内容")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \nshow_image_direct_url "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" True\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("glance_store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#stores = file,http")]),s._v("\ndemo_store "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\nfilesystem_store_datadir "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /var/lib/glance/images/\nstores "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rbd,file,http\ndefault_store "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rbd\nrbd_store_pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" images\nrbd_store_user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" glance\nrbd_store_ceph_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etc/ceph/ceph.conf\nrbd_store_chunk_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在[paste_deploy]部分添加如下内容，避免 images 缓存到/var/lib/glance/image-cache 目录下")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("paste_deploy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \nflavor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" keystone\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("在控制节点**（controller）**重启 glance-api 服务。")]),s._v(" "),a("p",[s._v("验证是否上传成功。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart openstack-glance-api.service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openstack image create  cirros --disk-format qcow2 --container-format bare --file cirros-0.3.4-x86_64-disk.img ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openstack image list ")]),s._v("\n+--------------------------------------+-----------+--------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ID                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Name      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Status "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+--------------------------------------+-----------+--------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 529f252c-f626-4896-a5b2-31b2fec4d335 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cirros    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" active "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+--------------------------------------+-----------+--------+\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd ls images ")]),s._v("\n529f252c-f626-4896-a5b2-31b2fec4d335\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd info images/529f252c-f626-4896-a5b2-31b2fec4d335")]),s._v("\nrbd image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'529f252c-f626-4896-a5b2-31b2fec4d335'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n        size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" MiB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" objects\n        order "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" MiB objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        snapshot_count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        id: 5f20a89f374c\n        block_name_prefix: rbd_data.5f20a89f374c\n        format: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features: \n        flags: \n        create_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 00:18:59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        access_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 00:54:17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        modify_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 00:18:59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h5",{attrs:{id:"🏷️配置cinder集成ceph"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置cinder集成ceph"}},[s._v("#")]),s._v(" 🏷️配置Cinder集成Ceph")]),s._v(" "),a("p",[s._v("在 Cinder 控制节点**（controller）**上，修改配置文件/etc/cinder/cinder.conf 在[DEFAULT]部分，将默认 volume 设置为 ceph。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/cinder/cinder.conf ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#default_volume_type = hdd ")]),s._v("\ndefault_volume_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ceph\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("修改 default_volume_type会重新往 cinder 库中 volume_types 表中增加一条名为 ceph 的记录在控制节点重启 cinder-api 和 cinder-scheduler 服务。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart openstack-cinder-api.service openstack-cinder-scheduler.service")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在 Cinder 存储节点**（compute）**上，修改配置文件/etc/cinder/cinder.conf。")]),s._v(" "),a("blockquote",[a("p",[s._v("说明：此处 rbd_secret_uuid 的值即为配置 Ceph 环境保存的 UUID 值")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/cinder/cinder.conf")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在[DEFAULT]部分，注释已经有的 enabled_backends")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#enabled_backends = lvm ")]),s._v("\nenabled_backends "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ceph,lvm\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件末尾添加[ceph]部分")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ceph"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nvolume_driver "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cinder.volume.drivers.rbd.RBDDriver\nvolume_backend_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ceph\nrbd_pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" volumes\nrbd_ceph_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etc/ceph/ceph.conf\nrbd_flatten_volume_from_snapshot "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nrbd_max_clone_depth "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nrbd_store_chunk_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\nrados_connect_timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" -1\nglance_api_version "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nrbd_user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cinder\nrbd_secret_uuid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 8fc81390-ad91-4814-a35a-e5bf716f0533\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart openstack-cinder-volume.service")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("验证测试。 通过创建卷类型，手动更新元数据，默认创建卷就是Ceph类型。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108217.png",alt:"image-20220305213837675"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108404.png",alt:"image-20220305213945870"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108596.png",alt:"image-20220305214028228"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108606.png",alt:"image-20220305214047958"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111108165.png",alt:"image-20220305214210760"}})]),s._v(" "),a("p",[s._v("通过rbd查看volumes是否被使用，当然，volume创建已经默认是ceph的存储池了。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd ls volumes")]),s._v("\nvolume-2273953c-9f4d-450b-b8ee-6aeaac473923\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd info volumes/volume-2273953c-9f4d-450b-b8ee-6aeaac473923")]),s._v("\nrbd image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'volume-2273953c-9f4d-450b-b8ee-6aeaac473923'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n        size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" GiB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v(" objects\n        order "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" MiB objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        snapshot_count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        id: 5b34e5750378\n        block_name_prefix: rbd_data.5b34e5750378\n        format: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features: \n        flags: \n        create_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 05:41:55 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        access_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 05:41:55 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        modify_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 05:41:55 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h5",{attrs:{id:"🏷️配置cinder-backup集成ceph"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置cinder-backup集成ceph"}},[s._v("#")]),s._v(" 🏷️配置Cinder_backup集成Ceph")]),s._v(" "),a("p",[s._v("cinder-backup 用于将卷（volume）备份到其他存储系统上，目前支持的备份存储系统有 swift、ceph 以及 IBM Tivoli Storage Manager(TSM)，默认为 Swift，但需要配置 swift 组件。")]),s._v(" "),a("p",[s._v("在存储节点(compute01、compute02）上修改配置文件/etc/cinder/cinder.conf")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/cinder/cinder.conf   ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在[DEFAULT]部分，增加如下内容")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nbackup_driver "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cinder.backup.drivers.ceph.CephBackupDriver \nbackup_ceph_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etc/ceph/ceph.conf \nbackup_ceph_user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cinder-backup \nbackup_ceph_chunk_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194304")]),s._v(" \nbackup_ceph_pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" backups \nbackup_ceph_stripe_unit "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \nbackup_ceph_stripe_count "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrestore_discard_excess_bytes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("在r配置参数back_driver时需要注释掉其他 backup_driver 的配置。另外，在controller的dashboard 配置（/etc/openstack-dashboard/local_settings）中的 OPENSTACK_CINDER_FEATURES 中增加如下配置。")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# vi /etc/openstack-dashboard/local_settings \nOPENSTACK_CINDER_FEATURES = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n'enable_backup'"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" True"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("重启Cinder backup和httpd服务。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl enable openstack-cinder-backup.service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@compute ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart openstack-cinder-backup.service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart httpd ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"🏷️配置nova集成ceph"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置nova集成ceph"}},[s._v("#")]),s._v(" 🏷️配置Nova集成Ceph")]),s._v(" "),a("p",[s._v("在 Nova 计算节点（controller/compute）上，修改配置文件/etc/nova/nova.conf vim /etc/nova/nova.conf。")]),s._v(" "),a("blockquote",[a("p",[s._v("说明：nova 集成 ceph，允许从 ceph 卷上启动实例。当 cinder 挂载或者卸载块设备时，libvirt 进程需要有访问 ceph 集群的权限。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/nova/nova.conf")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 支持热迁移")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("live_migration_flag")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER,VIR_MIGRATE_LIVE,VIR_MIGRATE_PERSIST_DEST,VIR_MIGRA TE_TUNNELLED"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 支持自动伸缩")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("resize_confirm_window")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("allow_resize_to_same_host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("allow_migrate_to_same_host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("libvirt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virt_type = qemu ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("inject_partition")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-2 \nvirt_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" kvm \nimages_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rbd \nimages_rbd_pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" vms \nimages_rbd_ceph_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etc/ceph/ceph.conf \n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("disk_cachemodes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"network=writeback"')]),s._v(" \nrbd_user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cinder\nrbd_secret_uuid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 8fc81390-ad91-4814-a35a-e5bf716f0533\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("在 Nova 计算节点（controller/computer）上，重启 nova-compute 服务。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart openstack-nova-compute.service")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("验证测试，通过创建云主机查看vms是否有资源。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd ls vms")]),s._v("\n f6c5f9d2-0853-4cf9-8141-6ae80ed73513_disk\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@controller ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  rbd info vms/f6c5f9d2-0853-4cf9-8141-6ae80ed73513_disk")]),s._v("\nrbd image "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'f6c5f9d2-0853-4cf9-8141-6ae80ed73513_disk'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("\n        size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" GiB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),s._v(" objects\n        order "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" MiB objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        snapshot_count: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        id: 45cf504b77fd\n        block_name_prefix: rbd_data.45cf504b77fd\n        format: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten\n        op_features: \n        flags: \n        create_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 03:30:21 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        access_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 05:21:14 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n        modify_timestamp: Sun Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 05:22:26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("当前的Ceph集群读写稳定。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109238.png",alt:"image-20220305215703048"}})]),s._v(" "),a("h3",{attrs:{id:"prometheus监控ceph集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prometheus监控ceph集群"}},[s._v("#")]),s._v(" Prometheus监控Ceph集群")]),s._v(" "),a("h5",{attrs:{id:"🏷️安装grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️安装grafana"}},[s._v("#")]),s._v(" 🏷️安装grafana")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y grafana ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y  ntp ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ntpdate ntp.aliyun.com")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl start  grafana-server ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl enable   grafana-server      ")]),s._v("\nCreated symlink from /etc/systemd/system/multi-user.target.wants/grafana-server.service to /usr/lib/systemd/system/grafana-server.service.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("访问http://172.25.254.130:3000   (默认用户admin密码admin)")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109752.png",alt:"image-20220306094104974"}})]),s._v(" "),a("h5",{attrs:{id:"🏷️安装prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️安装prometheus"}},[s._v("#")]),s._v(" 🏷️安装prometheus")]),s._v(" "),a("p",[s._v("使用Prometheus离线包，配置systemd服务启动。")]),s._v(" "),a("p",[s._v("启动服务和添加开机自启动。")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("--config.file")]),s._v(" \t\t\t\t\t   -- 指明prometheus的配置文件路径")]),s._v(" "),a("p",[a("code",[s._v("--web.enable-lifecycle")]),s._v("      -- 指明prometheus配置更改后可以进行热加载")]),s._v(" "),a("p",[a("code",[s._v("--storage.tsdb.path")]),s._v("           -- 指明监控数据存储路径")]),s._v(" "),a("p",[a("code",[s._v("--storage.tsdb.retention")]),s._v("   --指明数据保留时间")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf prometheus-2.29.1.linux-amd64.tar.gz ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv prometheus-2.29.1.linux-amd64 /opt/prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /opt/prometheus/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./prometheus --version ")]),s._v("\nprometheus, version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.29")]),s._v(".1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("branch: HEAD, revision: dcb07e8eac34b5ea37cd229545000b857f1c1637"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  build user:       root@364730518a4e\n  build date:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210811")]),s._v("-14:48:27\n  go version:       go1.16.7\n  platform:         linux/amd64\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/lib/systemd/system/prometheus.service ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Prometheus\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Documentation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Prometheus\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/prometheus/prometheus "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --config.file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/prometheus/prometheus.yml "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --web.listen-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(":9090\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on-failure\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl daemon-reload ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl start prometheus   ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl enable prometheus      ")]),s._v("\nCreated symlink from /etc/systemd/system/multi-user.target.wants/prometheus.service to /usr/lib/systemd/system/prometheus.service.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("通过http://172.25.254.130:9090可以访问。")]),s._v(" "),a("p",[s._v("通过访问Status下面的Target可以看到当前的标签。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109229.png",alt:"image-20220306110437873"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109917.png",alt:"image-20220306095400831"}})]),s._v(" "),a("h5",{attrs:{id:"🏷️ceph开启prometheus插件配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️ceph开启prometheus插件配置"}},[s._v("#")]),s._v(" 🏷️ceph开启prometheus插件配置")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("在cephnode01上配置")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mgr module enable prometheus ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ss -ntpl | grep 9283")]),s._v("\nLISTEN     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":9283                  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":*                   users:"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v('"ceph'),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v('mgr"'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("pid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5243")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("以下都是属于Ceph集群的监控指标。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109480.png",alt:"image-20220306095631900"}})]),s._v(" "),a("h5",{attrs:{id:"🏷️配置prometheus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置prometheus"}},[s._v("#")]),s._v(" 🏷️配置prometheus")]),s._v(" "),a("p",[s._v("在 scrape_configs: 配置项下添加。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("scrape_configs:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.")]),s._v("\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus"')]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# metrics_path defaults to '/metrics'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scheme defaults to 'http'.")]),s._v("\n\n    static_configs:\n      - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:9090"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n      \n      \n----------------------------------------------------\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在这末尾添加如下配置,每个Job必须要分开写。 ")]),s._v("\n\n  - job_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph_cluster'")]),s._v("        \n    honor_labels: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    scrape_interval: 5s\n    static_configs:\n      - targets: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'172.25.254.130:9283'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        labels:\n          instance: ceph       \n          \n          \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart prometheus")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("回去查看当前的Target已经刷新了，Ceph集群的监控指标已经收集完成。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109526.png",alt:"image-20220306100007678"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109744.png",alt:"image-20220306110412319"}})]),s._v(" "),a("h5",{attrs:{id:"🏷️配置grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🏷️配置grafana"}},[s._v("#")]),s._v(" 🏷️配置grafana")]),s._v(" "),a("p",[s._v("浏览器登录 grafana 管理界面，http://172.25.254.130:3000/")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109931.png",alt:"image-20220306100335172"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109290.png",alt:"image-20220306100420445"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111112536.png",alt:"image-20220306100505907"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109791.png",alt:"image-20220306101005324"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109104.png",alt:"image-20220306101207836"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111109978.png",alt:"image-20220306110621651"}})])])}),[],!1,null,null,null);t.default=n.exports}}]);