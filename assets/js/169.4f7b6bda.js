(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{649:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"监控、审计和运行时安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控、审计和运行时安全"}},[s._v("#")]),s._v(" 监控、审计和运行时安全")]),s._v(" "),a("h3",{attrs:{id:"主要内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[s._v("#")]),s._v(" 主要内容")]),s._v(" "),a("p",[s._v("❖ 分析容器系统调用：Sysdig")]),s._v(" "),a("p",[s._v("❖ 监控容器运行时：Falco")]),s._v(" "),a("p",[s._v("❖ Kubernetes 审计日志")]),s._v(" "),a("h3",{attrs:{id:"分析容器系统调用-sysdig"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析容器系统调用-sysdig"}},[s._v("#")]),s._v(" 分析容器系统调用：Sysdig")]),s._v(" "),a("h4",{attrs:{id:"sysdig简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sysdig简介"}},[s._v("#")]),s._v(" Sysdig简介")]),s._v(" "),a("p",[s._v("Sysdig：一个非常强大的系统监控、分析和故障排查工具。")]),s._v(" "),a("p",[s._v("汇聚 strace+tcpdump+htop+iftop+lsof 工具功能于一身！")]),s._v(" "),a("p",[s._v("sysdig 除了能获取系统资源利用率、进程、网络连接、系统调用等信息， 还具备了很强的分析能力，例如：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("按照CPU使用率对进程排序")])]),s._v(" "),a("li",[a("p",[s._v("按照数据包对进程排序")])]),s._v(" "),a("li",[a("p",[s._v("打开最多的文件描述符进程")])]),s._v(" "),a("li",[a("p",[s._v("查看进程打开了哪些文件")])]),s._v(" "),a("li",[a("p",[s._v("查看进程的HTTP请求报文")])]),s._v(" "),a("li",[a("p",[s._v("查看机器上容器列表及资源使用情况")])])]),s._v(" "),a("p",[s._v("项目地址：https://github.com/draios/sysdig")]),s._v(" "),a("p",[s._v("文档：https://github.com/draios/sysdig/wiki")]),s._v(" "),a("p",[s._v("sysdig 通过在内核的驱动模块注册系统调用的 hook，这样当有系 统调用发生和完成的时候，它会把系统调用信息拷贝到特定的 buffer，然后用户态组件对数据信息处理（解压、解析、过滤等）， 并最终通过 sysdig 命令行和用户进行交互。")]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059040.png",alt:"image-20220414220604964"}}),s._v(" "),a("h4",{attrs:{id:"安装sysdig"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装sysdig"}},[s._v("#")]),s._v(" 安装sysdig")]),s._v(" "),a("p",[s._v("导入sysdig的repo源，安装epel源。")]),s._v(" "),a("p",[s._v("安装完sysdig的时候，需要更新一下软件包，会更新sysdig，才能加载模块。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -s -o /etc/yum.repos.d/draios.repo https://s3.amazonaws.com/download.draios.com/stable/rpm/draios.repo")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install epel-release -y")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install sysdig -y")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum update -y ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /usr/bin/sysdig-probe-loader # 加载驱动模块")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"sysdig常用参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sysdig常用参数"}},[s._v("#")]),s._v(" sysdig常用参数")]),s._v(" "),a("p",[a("code",[s._v("-l, --list")]),s._v("：列出可用于过滤和输出的字段")]),s._v(" "),a("p",[a("code",[s._v("-M")]),s._v("  ：多少秒后停止收集")]),s._v(" "),a("p",[a("code",[s._v("-p")]),s._v(" , --print= ：指定打印事件时使用的格式")]),s._v(" "),a("ul",[a("li",[s._v("使用-pc或-pcontainer 容器友好的格式")]),s._v(" "),a("li",[s._v("使用-pk或-pkubernetes k8s友好的格式")])]),s._v(" "),a("p",[a("code",[s._v("-c")]),s._v("  ：指定内置工具，可直接完成具体的数据聚合、分析工作")]),s._v(" "),a("p",[a("code",[s._v("-w")]),s._v(" ：保存到文件中")]),s._v(" "),a("p",[a("code",[s._v("-r")]),s._v(" ：从文件中读取")]),s._v(" "),a("p",[s._v("执行sysdig命令，实时输出大量系统调用。")]),s._v(" "),a("p",[s._v("示例：59509 23:59:19.023099531 0 kubelet (1738) < epoll_ctl")]),s._v(" "),a("p",[s._v("格式：%evt.num %evt.outputtime %evt.cpu %proc.name (%thread.tid) %evt.dir %evt.type %evt.info")]),s._v(" "),a("p",[a("code",[s._v("evt.num")]),s._v("： 递增的事件号")]),s._v(" "),a("p",[a("code",[s._v("evt.time")]),s._v("： 事件发生的时间")]),s._v(" "),a("p",[a("code",[s._v("evt.cpu")]),s._v("： 事件被捕获时所在的 CPU，也就是系统调用是在哪个 CPU 执行的")]),s._v(" "),a("p",[a("code",[s._v("proc.name")]),s._v("： 生成事件的进程名字")]),s._v(" "),a("p",[a("code",[s._v("thread.tid")]),s._v("： 线程的 id，如果是单线程的程序，这也是进程的 pid")]),s._v(" "),a("p",[a("code",[s._v("evt.dir")]),s._v("： 事件的方向（direction），> 代表进入事件，< 代表退出事件")]),s._v(" "),a("p",[a("code",[s._v("evt.type")]),s._v("： 事件的名称，比如 open、stat等，一般是系统调用")]),s._v(" "),a("p",[a("code",[s._v("evt.args")]),s._v("： 事件的参数。如果是系统调用，这些对应着系统调用的参数")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("自定义格式输出")]),s._v("："),a("code",[s._v('sysdig -p "user:%user.name time:%evt.time proc_name:%proc.name"')])])]),s._v(" "),a("h4",{attrs:{id:"sysdig过滤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sysdig过滤"}},[s._v("#")]),s._v(" sysdig过滤")]),s._v(" "),a("ol",[a("li",[s._v("**fd：**根据文件描述符过滤，比如 fd 标号（fd.num）、fd 名字（fd.name）")]),s._v(" "),a("li",[s._v("**process：**根据进程信息过滤，比如进程 id（proc.id）、进程名（proc.name）")]),s._v(" "),a("li",[s._v("**evt：**根据事件信息过滤，比如事件编号、事件名")]),s._v(" "),a("li",[s._v("**user：**根据用户信息过滤，比如用户 id、用户名、用户 home 目录")]),s._v(" "),a("li",[s._v("**syslog：**根据系统日志过滤，比如日志的严重程度、日志的内容")]),s._v(" "),a("li",[s._v("**container：**根据容器信息过滤，比如容器ID、容器名称、容器镜像")])]),s._v(" "),a("p",[s._v("查看完整过滤器列表：sysdig -l")]),s._v(" "),a("p",[s._v("示例：")]),s._v(" "),a("p",[s._v("1、查看一个进程的系统调用")]),s._v(" "),a("p",[s._v("sysdig proc.name=kubelet")]),s._v(" "),a("p",[s._v("2、查看建立TCP连接的事件")]),s._v(" "),a("p",[s._v("sysdig evt.type=accept")]),s._v(" "),a("p",[s._v("3、查看/etc目录下打开的文件描述符")]),s._v(" "),a("p",[s._v("sysdig fd.name contains /etc")]),s._v(" "),a("p",[s._v("4、查看容器的系统调用")]),s._v(" "),a("p",[s._v("sysdig -M 10 container.name=web")]),s._v(" "),a("blockquote",[a("p",[s._v("注：还支持运算操作符，= 、!=、>=、>、<、 <=、contains、in 、exists、and、or、not")])]),s._v(" "),a("h4",{attrs:{id:"chisels工具箱"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#chisels工具箱"}},[s._v("#")]),s._v(" Chisels工具箱")]),s._v(" "),a("p",[s._v("**Chisels：**实用的工具箱，一组预定义的功能集合，用来分析特定的场景。")]),s._v(" "),a("p",[a("strong",[s._v("sysdig –cl")]),s._v(" 列出所有Chisels，以下是一些常用的：")]),s._v(" "),a("ul",[a("li",[s._v("topprocs_cpu：输出按照 CPU 使用率排序的进程列表，例如sysdig -c")]),s._v(" "),a("li",[s._v("topprocs_net：输出进程使用网络TOP")]),s._v(" "),a("li",[s._v("topprocs_file：进程读写磁盘文件TOP")]),s._v(" "),a("li",[s._v("topfiles_bytes：读写磁盘文件TOP")]),s._v(" "),a("li",[s._v("netstat：列出网络的连接情况")])]),s._v(" "),a("h4",{attrs:{id:"其他常用命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他常用命令"}},[s._v("#")]),s._v(" 其他常用命令")]),s._v(" "),a("p",[s._v("sysdig -c netstat\nsysdig -c ps\nsysdig -c lsof")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th"),s._v(" "),a("th")])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("网络")]),s._v(" "),a("td",[s._v("# 查看使用网络的进程"),a("br"),s._v("TOP sysdig -c topprocs_net "),a("br"),s._v("# 查看建立连接的端口 "),a("br"),s._v('sysdig -c fdcount_by fd.sport "evt.type=accept" -M 10 '),a("br"),s._v("# 查看建立连接的端口 "),a("br"),s._v("sysdig -c fdbytes_by fd.sport "),a("br"),s._v("# 查看建立连接的IP "),a("br"),s._v('sysdig -c fdcount_by fd.cip "evt.type=accept" -M 10 '),a("br"),s._v("# 查看建立连接的IP "),a("br"),s._v("sysdig -c fdbytes_by fd.cip")])]),s._v(" "),a("tr",[a("td",[s._v("硬盘")]),s._v(" "),a("td",[s._v("# 查看进程磁盘I/O读写 "),a("br"),s._v("sysdig -c topprocs_file "),a("br"),s._v("# 查看进程打开的文件描述符数量 "),a("br"),s._v('sysdig -c fdcount_by proc.name "fd.type=file" -M 10 '),a("br"),s._v("# 查看读写磁盘文件 "),a("br"),s._v("sysdig -c topfiles_bytes sysdig -c topfiles_bytes proc.name=etcd "),a("br"),s._v("# 查看/tmp目录读写磁盘活动文件 "),a("br"),s._v('sysdig -c fdbytes_by fd.filename "fd.directory=/tmp/"')])]),s._v(" "),a("tr",[a("td",[s._v("CPU")]),s._v(" "),a("td",[s._v("# 查看CPU使用率TOP "),a("br"),s._v("sysdig -c topprocs_cpu "),a("br"),s._v("# 查看容器CPU使用率TOP "),a("br"),s._v("sysdig -pc -c topprocs_cpu container.name=web "),a("br"),s._v("sysdig -pc -c topprocs_cpu container.id=web")])]),s._v(" "),a("tr",[a("td",[s._v("容器")]),s._v(" "),a("td",[s._v("# 查看机器上容器列表及资源使用情况 "),a("br"),s._v("csysdig –vcontainers "),a("br"),s._v("# 查看容器资源使用TOP "),a("br"),s._v("sysdig -c topcontainers_cpu/topcontainers_net/topcontainers_file")])])])]),s._v(" "),a("h3",{attrs:{id:"监控容器运行时-falco"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控容器运行时-falco"}},[s._v("#")]),s._v(" 监控容器运行时：Falco")]),s._v(" "),a("h4",{attrs:{id:"falco简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#falco简介"}},[s._v("#")]),s._v(" Falco简介")]),s._v(" "),a("p",[s._v("Falco 是一个 Linux 安全工具，它使用系统调用来保护和监控系统。 Falco最初是由Sysdig开发的，后来加入CNCF孵化器，成为首个加入CNCF的运行时安全项目。")]),s._v(" "),a("p",[s._v("Falco提供了一组默认规则，可以监控内核态的异常行为，例如：")]),s._v(" "),a("ul",[a("li",[s._v("对于系统目录/etc, /usr/bin, /usr/sbin的读写行为")]),s._v(" "),a("li",[s._v("文件所有权、访问权限的变更")]),s._v(" "),a("li",[s._v("从容器打开shell会话")]),s._v(" "),a("li",[s._v("容器生成新进程")]),s._v(" "),a("li",[s._v("特权容器启动")])]),s._v(" "),a("p",[s._v("项目地址：https://github.com/falcosecurity/falco")]),s._v(" "),a("h4",{attrs:{id:"falco架构图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#falco架构图"}},[s._v("#")]),s._v(" Falco架构图")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059595.png",alt:"image-20220414231953852"}})]),s._v(" "),a("h4",{attrs:{id:"安装falco"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装falco"}},[s._v("#")]),s._v(" 安装falco")]),s._v(" "),a("p",[s._v("falco配置文件目录：/etc/falco")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("falco.yaml")]),s._v(" falco配置与输出告警通知方式")]),s._v(" "),a("li",[a("code",[s._v("falco_rules.yaml")]),s._v(" 规则文件，默认已经定义很多威胁场景")]),s._v(" "),a("li",[a("code",[s._v("falco_rules.local.yaml")]),s._v(" 自定义扩展规则文件")]),s._v(" "),a("li",[a("code",[s._v("k8s_audit_rules.yaml")]),s._v(" K8s审计日志规则")])]),s._v(" "),a("p",[s._v("安装文档：https://falco.org/zh/docs/installation")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -s -o /etc/yum.repos.d/falcosecurity.repo https://falco.org/repo/falcosecurity-rpm.repo")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install epel-release -y")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum update")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install falco -y")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl start falco")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl enable falco")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# touch abc /usr/sbin/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -f /var/log/messages")]),s._v("\n\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" 02:04:03 master01 falco: 02:04:03.052503851: Error File below /etc opened "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" writing "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user_loginuid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("touch abc /usr/sbin/ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("parent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bash "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pcmdline")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bash "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/falco/abc "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("program")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("touch "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gparent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sshd "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ggparent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sshd "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gggparent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("systemd "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("NA"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"falco告警规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#falco告警规则"}},[s._v("#")]),s._v(" falco告警规则")]),s._v(" "),a("p",[s._v("告警规则示例（falco_rules.local.yaml）：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim falco_rules.local.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(' The program "sudo" is run in a container\n  '),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" An event will trigger every time you run sudo in a container\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("condition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" evt.type = execve and evt.dir=< and container.id "),a("span",{pre:!0,attrs:{class:"token tag"}},[s._v("!=")]),s._v(" host and proc.name = sudo\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Sudo run in container (user=%user.name %container.info parent=%proc.pname cmdline=%proc.cmdline)"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ERROR\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("users"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数说明"}},[s._v("#")]),s._v(" 参数说明")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("rule")]),s._v("：规则名称，唯一")]),s._v(" "),a("li",[a("code",[s._v("desc")]),s._v("：规则的描述")]),s._v(" "),a("li",[a("code",[s._v("condition")]),s._v("： 条件表达式")]),s._v(" "),a("li",[a("code",[s._v("output")]),s._v("：符合条件事件的输出格式")]),s._v(" "),a("li",[a("code",[s._v("priority")]),s._v("：告警的优先级")]),s._v(" "),a("li",[a("code",[s._v("tags")]),s._v("：本条规则的 tags 分类")])]),s._v(" "),a("h4",{attrs:{id:"威胁场景测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#威胁场景测试"}},[s._v("#")]),s._v(" "),a("strong",[s._v("威胁场景测试")])]),s._v(" "),a("p",[s._v("1、监控系统二进制文件目录读写（默认规则）")]),s._v(" "),a("p",[s._v("2、监控根目录或者/root目录写入文件（默认规则）")]),s._v(" "),a("p",[s._v("3、监控运行交互式Shell的容器（默认规则）")]),s._v(" "),a("p",[s._v("4、监控容器创建的不可信任进程（自定义规则）")]),s._v(" "),a("p",[s._v("验证：tail -f /var/log/messages（告警通知默认输出到标准输出和系统日志）")]),s._v(" "),a("p",[a("strong",[s._v("监控容器创建的不可信任进程规则")])]),s._v(" "),a("p",[s._v("在falco_rules.local.yaml文件添加：")]),s._v(" "),a("p",[s._v("condition表达式解读：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("spawned_process")]),s._v(" 运行新进程")]),s._v(" "),a("li",[a("code",[s._v("container")]),s._v(" 容器")]),s._v(" "),a("li",[a("code",[s._v("container.image startswith nginx")]),s._v(" 以nginx开头的容器镜像")]),s._v(" "),a("li",[a("code",[s._v("not proc.name in (nginx)")]),s._v(" 不属于nginx的进程名称（允许进程名称列表）")])]),s._v(" "),a("blockquote",[a("p",[s._v("重启falco应用新配置文件：")]),s._v(" "),a("p",[a("code",[s._v("systemctl restart falco")])])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim falco_rules.local.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Unauthorized process on nginx containers\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("condition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" spawned_process and container and container.image startswith nginx and not proc.name in (nginx)\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Unauthorized process on nginx containers (user=%user.name container_name=%container.name container_id=%container.id image=%container.image.repository shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty)"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("priority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" WARNING\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart falco")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# journalctl -u falco -f  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Logs begin at Thu 2022"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("04"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("14 14"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("39"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("00 UTC. "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Stopped Falco")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Container Native Runtime Security.\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Starting Falco")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Container Native Runtime Security"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Started Falco")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Container Native Runtime Security.\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Falco version 0.31.1 (driver version b7eb0dd65226a8dc254d228c8d950d07bf3521d2)\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Falco initialized with configuration file /etc/falco/falco.yaml\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Loading rules from file /etc/falco/falco_rules.yaml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("05 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Loading rules from file /etc/falco/falco_rules.local.yaml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("06 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("Loading rules from file /etc/falco/k8s_audit_rules.yaml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("07 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Starting internal webserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" listening on port 8765\nApr 15 02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("38"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("07 master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116163")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("02:38:07.523070816")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Informational Privileged container started (user=<NA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" user_loginuid=0 command=container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("8ab8ea9eb331 kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("proxy (id=8ab8ea9eb331) image=registry.aliyuncs.com/google_containers/kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1.22.1)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("创建container容器之后触发falco")]),s._v(" "),a("ol",[a("li",[s._v("第一次创建"),a("code",[s._v("nginx")]),s._v("的"),a("code",[s._v("container")]),s._v("的时候输入创建")]),s._v(" "),a("li",[s._v("第二次使用tail查看日志，触发"),a("code",[s._v("faclo")]),s._v("有输出"),a("code",[s._v("shell=tail")]),s._v("字段")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d nginx ")]),s._v("\n801e315438d5e62c0d02eff444df9b17a9e7d635061e85037df56be9eaa02c4d\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -f /var/log/messages")]),s._v("\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" 02:39:34 master01 falco: 02:39:34.313610957: Warning Unauthorized process on nginx containers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cool_heisenberg "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("801e315438d5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("shell")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("md5sum "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("parent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("-listen-on-ip "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cmdline")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("md5sum -c - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("terminal")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" 02:39:34 master01 falco: 02:39:34.319772871: Warning Unauthorized process on nginx containers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cool_heisenberg "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("801e315438d5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("shell")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sed "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("parent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("-listen-on-ip "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cmdline")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sed -i -E s,listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(",listen       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n    listen  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(", /etc/nginx/conf.d/default.conf "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("terminal")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it 801e315438d5 tail /var/log/nginx/access.log ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -f /var/log/messages")]),s._v("\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" 02:43:33 master01 falco: 02:43:33.449344235: Warning Unauthorized process on nginx containers "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cool_heisenberg "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("container_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("801e315438d5 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("shell")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("tail "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("parent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("runc "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cmdline")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("tail /var/log/nginx/access.log "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("terminal")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34816")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"falco输出方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#falco输出方式"}},[s._v("#")]),s._v(" Falco输出方式")]),s._v(" "),a("p",[a("strong",[s._v("Falco支持五种输出告警通知的方式：")])]),s._v(" "),a("ol",[a("li",[s._v("输出到标准输出（默认启用）")]),s._v(" "),a("li",[s._v("输出到文件")]),s._v(" "),a("li",[s._v("输出到Syslog（默认启用）")]),s._v(" "),a("li",[s._v("输出到HTTP服务")]),s._v(" "),a("li",[s._v("输出到其他程序（命令行管道方式）")])]),s._v(" "),a("p",[s._v("告警配置文件："),a("code",[s._v("/etc/falco/falco.yaml")])]),s._v(" "),a("p",[s._v("例如输出到指定文件，使用json格式：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim falco.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("json_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n···\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("syslog_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n···\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("file_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keep_alive")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/falco_events.log\n···\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stdout_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart falco ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"falco告警集中化展示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#falco告警集中化展示"}},[s._v("#")]),s._v(" Falco告警集中化展示")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151059354.png",alt:"image-20220415010916499"}})]),s._v(" "),a("p",[s._v("• FalcoSideKick：一个集中收集并指定输出，支持大量方式输出，例如Influxdb、Elasticsearch等")]),s._v(" "),a("p",[s._v("项目地址 https://github.com/falcosecurity/falcosidekick")]),s._v(" "),a("p",[s._v("• FalcoSideKick-UI：告警通知集中图形展示系统")]),s._v(" "),a("p",[s._v("项目地址 https://github.com/falcosecurity/falcosidekick-ui")]),s._v(" "),a("h4",{attrs:{id:"部署falco-ui"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署falco-ui"}},[s._v("#")]),s._v(" 部署Falco UI")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d \\")]),s._v("\n-p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2801")]),s._v(":2801 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--name falcosidekick "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEBUI_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.11.121.118:2802 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nfalcosecurity/falcosidekick\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d \\")]),s._v("\n-p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2802")]),s._v(":2802 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--name falcosidekick-ui "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nfalcosecurity/falcosidekick-ui \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker ps ")]),s._v("\nCONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS                                       NAMES\n9663f92ade3a   falcosecurity/falcosidekick-ui   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./falcosidekick-ui"')]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" minutes ago    Up "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" minutes    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:2802-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2802")]),s._v("/tcp, :::2802-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2802")]),s._v("/tcp   falcosidekick-ui\n80c5d162842f   falcosecurity/falcosidekick      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./falcosidekick"')]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" minutes ago    Up "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" minutes    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:2801-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2801")]),s._v("/tcp, :::2801-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2801")]),s._v("/tcp   falcosidekick\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("修改falco配置文件指定http方式输出：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim falco.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("json_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("json_include_output_property")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://10.11.121.118:2801/"')]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 falco"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart falco")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("UI访问地址：http://10.11.121.118:2802/ui/")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058161.png",alt:"image-20220415105834715"}})]),s._v(" "),a("h3",{attrs:{id:"kubernetes-审计日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-审计日志"}},[s._v("#")]),s._v(" Kubernetes 审计日志")]),s._v(" "),a("h4",{attrs:{id:"什么是审计日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是审计日志"}},[s._v("#")]),s._v(" 什么是审计日志？")]),s._v(" "),a("p",[s._v("在Kubernetes集群中，API Server的审计日志记录了哪些用户、哪些服务请求操作集群资源，并且可以编写不同规则， 控制忽略、存储的操作日志。 审计日志采用JSON格式输出，每条日志都包含丰富的元数据，例如请求的URL、HTTP方法、客户端来源等，你可以使 用监控服务来分析API流量，以检测趋势或可能存在的安全隐患。")]),s._v(" "),a("p",[s._v("这些可能服务会访问API Server：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("管理节点")]),s._v("（controller-manager、scheduler）")]),s._v(" "),a("li",[a("strong",[s._v("工作节点")]),s._v("（kubelet、kube-proxy）")]),s._v(" "),a("li",[a("strong",[s._v("集群服务")]),s._v("（CoreDNS、Calico、HPA等）")]),s._v(" "),a("li",[s._v("kubectl、API、Dashboard")])]),s._v(" "),a("h4",{attrs:{id:"事件阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事件阶段"}},[s._v("#")]),s._v(" 事件阶段")]),s._v(" "),a("p",[s._v("当客户端向 API Server发出请求时，该请求将经历一个或多个阶段：")]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058322.png",alt:"image-20220414232402761"}}),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("阶段")]),s._v(" "),a("th",[s._v("说明")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("RequestReceived")]),s._v(" "),a("td",[s._v("审核处理程序已收到请求")])]),s._v(" "),a("tr",[a("td",[s._v("ResponseStarted")]),s._v(" "),a("td",[s._v("已发送响应标头，但尚未发送响应正文")])]),s._v(" "),a("tr",[a("td",[s._v("ResponseComplete")]),s._v(" "),a("td",[s._v("响应正文已完成，不再发送任何字节")])]),s._v(" "),a("tr",[a("td",[s._v("Panic")]),s._v(" "),a("td",[s._v("内部服务器出错，请求未完成")])])])]),s._v(" "),a("h4",{attrs:{id:"审计日志策略规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#审计日志策略规则"}},[s._v("#")]),s._v(" 审计日志策略规则")]),s._v(" "),a("p",[s._v("Kubernetes审核策略文件包含一系列规则，描述了记录日志的级别， 采集哪些日志，不采集哪些日志。 规则级别如下表所示：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("级别")]),s._v(" "),a("th",[s._v("说明")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("None")]),s._v(" "),a("td",[s._v("不为事件创建日志条目")])]),s._v(" "),a("tr",[a("td",[s._v("Metadata")]),s._v(" "),a("td",[s._v("创建日志条目。包括元数据，但不包括请求正文或响应正文")])]),s._v(" "),a("tr",[a("td",[s._v("Request")]),s._v(" "),a("td",[s._v("创建日志条目。包括元数据和请求正文，但不包括响应正文")])]),s._v(" "),a("tr",[a("td",[s._v("RequestResponse")]),s._v(" "),a("td",[s._v("创建日志条目。包括元数据、请求正文和响应正文")])])])]),s._v(" "),a("p",[s._v("参考资料：https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/")]),s._v(" "),a("h4",{attrs:{id:"日志格式示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志格式示例"}},[s._v("#")]),s._v(" 日志格式示例")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058490.png",alt:"image-20220414232719211"}})]),s._v(" "),a("h4",{attrs:{id:"配置审计日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置审计日志"}},[s._v("#")]),s._v(" 配置审计日志")]),s._v(" "),a("p",[s._v("审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。")]),s._v(" "),a("p",[a("strong",[s._v("配置流程：")])]),s._v(" "),a("ol",[a("li",[s._v("准备配置文件（审计规则）")]),s._v(" "),a("li",[s._v("启用准入控制器")]),s._v(" "),a("li",[s._v("查看日志情况")])]),s._v(" "),a("p",[a("strong",[s._v("启用审计日志功能：")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204151058955.png",alt:"image-20220415000552047"}})]),s._v(" "),a("blockquote",[a("p",[s._v("注：需要使用hostpath数据卷将宿主 机策略文件和日志文件挂载到容器中")])]),s._v(" "),a("h5",{attrs:{id:"_1-准备配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-准备配置文件"}},[s._v("#")]),s._v(" 1.准备配置文件")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("/etc/kubernetes/")]),s._v("下创建"),a("code",[s._v("audit")]),s._v("目录")]),s._v(" "),a("p",[s._v("配置文件为"),a("code",[s._v("audit-policy.yaml")]),s._v("，准入控制器需要挂载该目录的文件。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/kubernetes/audit && cd /etc/kubernetes/audit")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat audit-policy.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit.k8s.io/v1 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This is required.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Policy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("omitStages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestReceived"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RequestResponse\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods/log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods/status"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"configmaps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resourceNames")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"controller-leader"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("users")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:kube-proxy"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"watch"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# core API group")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpoints"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"services"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("userGroups")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:authenticated"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nonResourceURLs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api*"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Wildcard matching.")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/version"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Request\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# core API group")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"configmaps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaces")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-system"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# core API group")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secrets"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"configmaps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Request\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# core API group")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"extensions"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("omitStages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestReceived"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("h5",{attrs:{id:"_2-启用准入控制器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-启用准入控制器"}},[s._v("#")]),s._v(" 2.启用准入控制器")]),s._v(" "),a("p",[s._v("审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。")]),s._v(" "),a("p",[s._v("启用审计日志功能：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/kubernetes/manifests/kube-apiserver.yaml")]),s._v("\n…\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/audit/audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy.yaml\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("path=/var/log/k8s_audit.log\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("maxage=30\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("maxbackup=10\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("maxsize=100\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/audit/audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy.yaml\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/k8s_audit.log\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/audit/audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy.yaml\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" File\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/k8s_audit.log\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" FileOrCreate\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart kubelet ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h5",{attrs:{id:"_3-查看日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-查看日志"}},[s._v("#")]),s._v(" 3.查看日志")]),s._v(" "),a("p",[s._v("测试查看当前的资源操作日志：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat  /var/log/k8s_audit.log")]),s._v("\n···\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Event"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"audit.k8s.io/v1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Metadata"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"auditID"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a2fb8bdd-1289-4045-b0f4-ccbafe4416c8"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stage"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ResponseComplete"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestURI"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/apis/discovery.k8s.io/v1/namespaces/default/endpointslices/kubernetes"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"verb"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:apiserver"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uid"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bb28e427-363f-4841-9925-7ae0f7af6c1d"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"groups"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:masters"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sourceIPs"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"::1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"userAgent"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-apiserver/v1.22.1 (linux/amd64) kubernetes/632ed30"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"objectRef"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resource"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"endpointslices"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubernetes"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiGroup"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"discovery.k8s.io"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"responseStatus"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"code"')]),s._v(":200"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestReceivedTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:13:56.054960Z"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stageTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:13:56.056415Z"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"annotations"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/decision"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/reason"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Event"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"audit.k8s.io/v1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Metadata"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"auditID"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"51e01b26-c275-4953-9472-efec1f8b0ca2"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stage"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ResponseComplete"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestURI"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/master02?timeout=10s"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"verb"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"update"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:node:master02"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"groups"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:nodes"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:authenticated"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sourceIPs"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.11.121.116"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"userAgent"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubelet/v1.22.1 (linux/amd64) kubernetes/632ed30"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"objectRef"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resource"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"leases"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kube-node-lease"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"master02"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uid"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b2b0fc89-4220-48ee-86c9-b08e8c283f94"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiGroup"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"coordination.k8s.io"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"921237"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"responseStatus"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"code"')]),s._v(":200"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestReceivedTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:13:56.316392Z"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stageTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:13:56.324183Z"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"annotations"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/decision"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/reason"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"_4-只记录指定资源操作日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-只记录指定资源操作日志"}},[s._v("#")]),s._v(" 4.只记录指定资源操作日志")]),s._v(" "),a("p",[s._v("创建日志条目,包括元数据，但不包括请求正文或响应正文支持资源如下：")]),s._v(" "),a("ul",[a("li",[s._v("pods")]),s._v(" "),a("li",[s._v("deployments")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat  /etc/kubernetes/audit/audit-policy.yaml  ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit.k8s.io/v1 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This is required.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Policy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("omitStages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestReceived"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("users")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("apiserver \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scheduler\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("proxy\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kubelet \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apps"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deployments"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep kubelet ")]),s._v("\nroot      72326  72272 10 16"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("04 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v("        00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("04"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("02 kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("apiserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address=10.11.121.118 \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 72326 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart kubelet ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("创建一个Pod查看当前的日志情况、使用jq转换为json查看：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl run  web-test-my-pod --image=nginx --image-pull-policy=IfNotPresent ")]),s._v("\npod/web created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /var/log/k8s_audit.log  | grep web-test-my-pod ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo \'{"kind":"Event","apiVersion":"audit.k8s.io/v1","level":"Metadata","auditID":"53298e83-3e00-471a-80b0-e7f9fa721be9","stage":"ResponseComplete","requestURI":"/api/v1/namespaces/default/pods?fieldManager=kubectl-run","verb":"create","user":{"username":"kubernetes-admin","groups":["system:masters","system:authenticated"]},"sourceIPs":["10.11.121.118"],"userAgent":"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78","objectRef":{"resource":"pods","namespace":"default","name":"web-test-my-pod","apiVersion":"v1"},"responseStatus":{"metadata":{},"code":201},"requestReceivedTimestamp":"2022-04-14T16:51:26.948369Z","stageTimestamp":"2022-04-14T16:51:26.959232Z","annotations":{"authorization.k8s.io/decision":"allow","authorization.k8s.io/reason":"","imagepolicywebhook.image-policy.k8s.io/failed-open":"true"}}\' | jq .')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Event"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"audit.k8s.io/v1"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"level"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Metadata"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"auditID"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"53298e83-3e00-471a-80b0-e7f9fa721be9"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stage"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ResponseComplete"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestURI"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api/v1/namespaces/default/pods?fieldManager=kubectl-run"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"verb"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"create"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubernetes-admin"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"groups"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:masters"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:authenticated"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sourceIPs"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.11.121.118"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"userAgent"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"objectRef"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resource"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web-test-my-pod"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"responseStatus"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"code"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("201")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requestReceivedTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:51:26.948369Z"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stageTimestamp"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-04-14T16:51:26.959232Z"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"annotations"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/decision"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization.k8s.io/reason"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicywebhook.image-policy.k8s.io/failed-open"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("h5",{attrs:{id:"_5-审计日志练习"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-审计日志练习"}},[s._v("#")]),s._v(" 5.审计日志练习")]),s._v(" "),a("p",[s._v("编辑和扩展基本策略到日志：")]),s._v(" "),a("ol",[a("li",[s._v("命名空间在 RequestResponse 级别更改")]),s._v(" "),a("li",[s._v("PV 的请求内容在 front-apps 命名空间发生了更改")]),s._v(" "),a("li",[s._v("Configmap 和 secret 在所有命名空间 Metadata 级别更改")]),s._v(" "),a("li",[s._v("另外，添加一个catch-all来记录在Metadata 级别的所有请求。")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/kubernetes/audit/audit-policy.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" audit.k8s.io/v1 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This is required.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Policy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("omitStages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestReceived"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RequestResponse   \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" \n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespaces"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Request\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"persistentvolumes"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaces")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"front-apps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secrets"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"configmaps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Metadata\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("omitStages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestReceived"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);