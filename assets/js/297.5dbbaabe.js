(window.webpackJsonp=window.webpackJsonp||[]).push([[297],{777:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"rancher多混合云平台管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rancher多混合云平台管理"}},[s._v("#")]),s._v(" Rancher多混合云平台管理")]),s._v(" "),a("h2",{attrs:{id:"如下是rancher的架构图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如下是rancher的架构图"}},[s._v("#")]),s._v(" 如下是Rancher的架构图")]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111156786.png",alt:"image-20211129083856224"}}),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("IP地址")]),s._v(" "),a("th",[s._v("主机名")]),s._v(" "),a("th",[s._v("节点")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("10.18.5.10")]),s._v(" "),a("td",[s._v("master01")]),s._v(" "),a("td",[s._v("Rancher master、K8S master、K8S worker")])]),s._v(" "),a("tr",[a("td",[s._v("10.18.5.11")]),s._v(" "),a("td",[s._v("master02")]),s._v(" "),a("td",[s._v("Rancher master、K8S master、K8S worker")])]),s._v(" "),a("tr",[a("td",[s._v("10.18.5.12")]),s._v(" "),a("td",[s._v("master03")]),s._v(" "),a("td",[s._v("Rancher master、K8S master、K8S worker")])]),s._v(" "),a("tr",[a("td",[s._v("10.18.5.13")]),s._v(" "),a("td",[s._v("nginx")]),s._v(" "),a("td",[s._v("Nginx")])]),s._v(" "),a("tr",[a("td",[s._v("10.18.5.14")]),s._v(" "),a("td",[s._v("cicd")]),s._v(" "),a("td",[s._v("GitLab、Harbor、Jenkins")])])])]),s._v(" "),a("h2",{attrs:{id:"部署harbor仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署harbor仓库"}},[s._v("#")]),s._v(" 部署Harbor仓库")]),s._v(" "),a("blockquote",[a("p",[a("strong",[a("code",[s._v("使用操作系统均为CentOS7.5-1804的")])])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("使用rancher_offline_installation_package.tar软件包")])])])]),s._v(" "),a("h3",{attrs:{id:"基础环境配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础环境配置"}},[s._v("#")]),s._v(" 基础环境配置")]),s._v(" "),a("blockquote",[a("h4",{attrs:{id:"在所有节点执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在所有节点执行"}},[s._v("#")]),s._v(" "),a("code",[s._v("在所有节点执行")])])]),s._v(" "),a("h4",{attrs:{id:"_1-配置yum源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置yum源"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（1）配置Yum源")])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("所有节点上传离线包rancher_offline_installation_package.tar,gz 至/root目录，解压安装包")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf rancher_offline_installation_package.tar")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd offline_installation_package/yum/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf rancher_yum.tar -C /opt/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /etc/yum.repos.d/* /media/ ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/yum.repos.d/rancher.repo ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rancher\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("baseurl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("file:///opt/rancher/\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gpgcheck")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("centos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("baseurl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.18.5.15/file/centos\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gpgcheck")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("enabled")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h4",{attrs:{id:"_2-配置主机映射"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置主机映射"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（2）配置主机映射")])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("修改主机名后配置主机映射")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/hosts")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1 localhost localhost.localdomain localhost6 localhost6.localdomain6\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.10 master01\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.11 master02\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.12 master03\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.13 nginx\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14 cicd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h4",{attrs:{id:"_3-配置防火墙及selinux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置防火墙及selinux"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（3）配置防火墙及SELinux")])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("清除所有的iptables规则以及关闭selinux")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl stop firewalld && systemctl disable firewalld")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -F \t\t\t\t\t\t# 清除所有制订的规则")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -X\t\t\t\t\t\t# 清除所有用户“自定义”的 chain")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -Z \t\t\t\t\t\t# 将所有 chain 的计数与流量统计都归零")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables-save")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_4-关闭swap分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-关闭swap分区"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（4）关闭Swap分区")])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("永久禁用虚拟内存")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swapoff -a ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's/.*swap.*/#&/' /etc/fstab")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"_5-配置路由转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-配置路由转发"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（5）配置路由转发")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat << EOF | tee /etc/sysctl.d/k8s.conf")]),s._v("\nnet.ipv4.ip_forward "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.bridge.bridge-nf-call-ip6tables "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.bridge.bridge-nf-call-iptables "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nEOF\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# modprobe br_netfilter")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl -p /etc/sysctl.d/k8s.conf")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_6-安装-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-安装-docker"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（6）安装 Docker")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install yum-utils device-mapper-persistent-data lvm2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /opt/rancher/base/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y containerd.io-1.2.13-3.1.el7.x86_64.rpm docker-ce-19.03.8-3.el7.x86_64.rpm docker-ce-cli-19.03.8-3.el7.x86_64.rpm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl start docker && systemctl enable docker")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_7-daemon-json文件配置如下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-daemon-json文件配置如下"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（7）daemon.json文件配置如下")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat > /etc/docker/daemon.json <<EOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"insecure-registries"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry-mirrors"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://7bezldxe.mirror.aliyuncs.com/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exec-opts"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"native.cgroupdriver=cgroupfs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"log-driver"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"json-file"')]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"log-opts"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-size"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100m"')]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max-file"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"storage-driver"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"overlay2"')]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"storage-opts"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"overlay2.override_kernel_check=true"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nEOF\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl daemon-reload && systemctl  restart docker")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"部署harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署harbor"}},[s._v("#")]),s._v(" 部署Harbor")]),s._v(" "),a("blockquote",[a("h4",{attrs:{id:"在cicd节点安装harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在cicd节点安装harbor"}},[s._v("#")]),s._v(" 在cicd节点安装Harbor")])]),s._v(" "),a("h4",{attrs:{id:"_1-安装docker-compose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装docker-compose"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（1）安装docker-compose")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x offline_installation_package/docker-compose/v1.25.5-docker-compose-Linux-x86_64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp offline_installation_package/docker-compose/v1.25.5-docker-compose-Linux-x86_64 /usr/local/bin/docker-compose")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker-compose version")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.25")]),s._v(".5, build 8a1c60f6\ndocker-py version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.1")]),s._v(".0\nCPython version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.7")]),s._v(".5\nOpenSSL version: OpenSSL "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(".0l "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_2-部署harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署harbor"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（2）部署Harbor")])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("修改Harbor配置信息（关于https的注释）")])]),s._v(" "),a("li",[a("strong",[s._v("解决Harbor报错问题（shadow文件的值）")])]),s._v(" "),a("li",[a("strong",[s._v("配置"),a("code",[s._v("rancher")]),s._v("用户密码"),a("code",[s._v("Rancher@123")]),s._v("以及创建两个仓库"),a("code",[s._v("rancher和cnrancher")])])]),s._v(" "),a("li",[a("strong",[s._v("导入需要上传的镜像（执行脚本push镜像）")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd offline_installation_package/harbor/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker load -i harbor.tar")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf harbor-online-installer-v1.10.2.tgz ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd harbor")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ol",[a("li",[a("strong",[s._v("此处需要修改配置文件")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi harbor.yml")]),s._v("\nhostname: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14 \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将域名修改为本机 IP")]),s._v("\nharbor_admin_password: Harbor12345\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#https: \t\t\t\t\t# 禁用 https")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https port for harbor, default is 443")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# port: 443")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The path of cert and key files for nginx")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# certificate: /your/certificate/path")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# private_key: /your/private/key/path")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("启动Harbor（这里将会出现报错）")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./install.sh --with-clair")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("strong",[s._v("导出harbor-log容器")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -p /tmp/harbor-log")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /tmp/harbor-log")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker export harbor-log -o harbor-log.tar")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[a("strong",[s._v("解压tar包，修改 shadow 文件的值")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar xvfp harbor-log.tar")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's/:90:/:99999:/g' /tmp/harbor-log/etc/shadow")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[a("strong",[s._v("将修改后的shadow文件挂载到harbor-log容器内")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -p /opt/harbor-log-etc/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /tmp/harbor-log/etc/shadow /opt/harbor-log-etc/shadow")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"6"}},[a("li",[a("strong",[s._v("修改docker-composr.yml文件，配置harbor-log容器的volumes")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor-log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/harbor/harbor/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi docker-compose.yml")]),s._v("\n volumes:\n   - /data/registry:/storage:z\n   - ./common/config/registry/:/etc/registry/:z\n   - type: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v("\n     source: /data/secret/registry/root.crt\n     target: /etc/registry/root.crt\n   - type: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" \t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加这一段，挂载刚刚修改的shadow")]),s._v("\n     source: /opt/harbor-log-etc/shadow\n     target: /etc/shadow\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ol",{attrs:{start:"7"}},[a("li",[a("strong",[s._v("重启Harbor")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker-compose down ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker-compose up -d ")]),s._v("\nCreating network "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"harbor_harbor"')]),s._v(" with the default driver\nCreating network "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"harbor_harbor-clair"')]),s._v(" with the default driver\nCreating harbor-log "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating redis         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating harbor-db     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating harbor-portal "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating registryctl   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating registry      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating harbor-core   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating clair         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating nginx             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating harbor-jobservice "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\nCreating clair-adapter     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"_3-上传镜像至harbor仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-上传镜像至harbor仓库"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（3）上传镜像至Harbor仓库")])]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("启动Harbor成功后，Web端登录Harbor（http://10.18.5.14），用户名为admin，密码为Harbor12345。")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111156799.png",alt:"image-20211129091737666"}}),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("在左侧导航栏选择“系统管理→用户管理→创建用户”菜单命令，创建rancher用户，密码为Rancher@123。")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111156437.png",alt:"image-20211129091827630"}}),s._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[a("strong",[s._v("Harbor切换为rancher用户登录，登录后创建项目（镜像仓库）rancher和cnrancher，访问级别为公开")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111156519.png",alt:"image-20211129092003723"}}),s._v(" "),a("h4",{attrs:{id:"_4-导入镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-导入镜像"}},[s._v("#")]),s._v(" "),a("strong",[s._v("（4）导入镜像")])]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("使用rancher用户登录Harbor仓库")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker login 10.18.5.14")]),s._v("\nUsername: rancher\nPassword: \nWARNING"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Your password will be stored unencrypted "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#credentials-store")]),s._v("\n\nLogin Succeeded\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("导入镜像")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/rancher-offline-images/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd rancher-offline-images"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker load -i rancher.tar")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd rancher-offline-images"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x *.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd rancher-offline-images"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./rancher-push-images.sh")]),s._v("\n\n输入镜像仓库地址"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("不加 http/https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14\n输入镜像仓库用户名: rancher\n输入镜像仓库用户密码: Rancher@123\n设置的仓库地址为: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14，用户名: rancher，密码: xxx\n是否确认"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Y/N"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": y\nWARNING"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Using --password via the CLI is insecure. Use --password-stdin.\nWARNING"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Your password will be stored unencrypted "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" \n/root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#credentials-store")]),s._v("\n镜像仓库 Login Succeeded\nThe push refers to repository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14/rancher/calico-cni"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("strong",[s._v("推送完成后，登录 Harbor并进入rancher项目")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111156531.png",alt:"image-20211129092634734"}}),s._v(" "),a("h2",{attrs:{id:"部署k8s-ha集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署k8s-ha集群"}},[s._v("#")]),s._v(" 部署K8S HA集群")]),s._v(" "),a("blockquote",[a("p",[a("strong",[a("code",[s._v("部署Nginx反向代理")])])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("部署Kubernetes HA集群")])])])]),s._v(" "),a("h3",{attrs:{id:"nginx节点部署反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx节点部署反向代理"}},[s._v("#")]),s._v(" Nginx节点部署反向代理")]),s._v(" "),a("blockquote",[a("h4",{attrs:{id:"使用nginx节点部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用nginx节点部署"}},[s._v("#")]),s._v(" "),a("code",[s._v("使用Nginx节点部署")])])]),s._v(" "),a("h4",{attrs:{id:"_1-编写配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写配置文件"}},[s._v("#")]),s._v(" （1）编写配置文件")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("在nginx节点编写nginx.conf文件")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nginx ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/nginx")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nginx ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/nginx/nginx.conf")]),s._v("\nworker_processes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nworker_rlimit_nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nevents "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n worker_connections "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nstream "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n upstream rancher_servers_https "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n \tleast_conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \tserver "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.10:30001 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \tserver "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.11:30001 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \tserver "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.12:30001 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_fails")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("fail_timeout")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("5s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n \tlisten "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \tproxy_pass rancher_servers_https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h4",{attrs:{id:"_2-启动nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-启动nginx"}},[s._v("#")]),s._v(" （2）启动Nginx")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("使用编辑好的配置文件/etc/nginx.conf，以容器的形式运行Nginx服务，而不需要将其安装在宿主机上。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nginx ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker login 10.18.5.14 -u rancher -p Rancher@123")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nginx ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name lb-nginx -d --restart=unless-stopped \\")]),s._v("\n-p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":80 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":443 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14/rancher/nginx:1.14\n\n20ee0cf1e14c21552c912ce9fe8783e4a4fe1c129142680bfc4601d1718455f8\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"部署kubernetes-ha集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署kubernetes-ha集群"}},[s._v("#")]),s._v(" 部署Kubernetes HA集群")]),s._v(" "),a("blockquote",[a("h4",{attrs:{id:"在所有master节点创建用户配置免密-master01作为主要工具节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在所有master节点创建用户配置免密-master01作为主要工具节点"}},[s._v("#")]),s._v(" "),a("code",[s._v("在所有Master节点创建用户配置免密，master01作为主要工具节点")])])]),s._v(" "),a("h4",{attrs:{id:"_1-创建用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建用户"}},[s._v("#")]),s._v(" （1）创建用户")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("因为CentOS的安全限制，无法使用root账户通过RKE安装K8S集群。所以无论是通过RKE还是Custom安装K8S，建议CentOS用户使用非root用户来运行Docker。")])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[a("code",[s._v("所有master节点需要创建rancher用户，设置从属组为docker")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# useradd -G docker rancher")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo -n rancher | passwd --stdin rancher")]),s._v("\nChanging password "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" user rancher.\npasswd: all authentication tokens updated successfully.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_2-配置免密"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置免密"}},[s._v("#")]),s._v(" （2）配置免密")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("所有master节点配置rancher用户SSH无密钥访问（密码为 rancher）")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-keygen")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for i in master01 master02 master03;do ssh-copy-id -i ~/.ssh/id_rsa.pub rancher@$i;done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"_3-安装rke工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装rke工具"}},[s._v("#")]),s._v(" （3）安装RKE工具")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp offline_installation_package/rke/v1.1.0-rke_linux-amd64 /usr/local/bin/rke")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x /usr/local/bin/rke")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rke -v")]),s._v("\nrke version v1.1.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_4-编写yaml文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-编写yaml文件"}},[s._v("#")]),s._v(" （4）编写YAML文件")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("在任意master节点编写rancher-cluster.yml文件，以master01为例")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi rancher-cluster.yaml")]),s._v("\nnodes:\n  - address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.10\n    user: rancher\n    role: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane,worker,etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  - address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.11\n    user: rancher\n    role: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane,worker,etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  - address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.12\n    user: rancher\n    role: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane,worker,etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 Harbor 私有仓库")]),s._v("\nprivate_registries:\n  - url: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14\n    user: rancher\n    password: Rancher@123\n    is_default: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    \nservices:\n  etcd:\n    extra_args:\n      auto-compaction-retention: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("240")]),s._v("\n      quota-backend-bytes: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'6442450944'")]),s._v("\n\t\t\t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改空间配额为$((6*1024*1024*1024))，默认 2G，最大 8G")]),s._v("\n    backup_config:\n      enabled: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" \t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 true 启用 etcd 自动备份，设置 false 禁用；")]),s._v("\n      interval_hours: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 快照创建间隔时间，不加此参数，默认 5 分钟；")]),s._v("\n      retention: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" \t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etcd 备份保留份数；")]),s._v("\n  ingress:\n    provider: none\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("h4",{attrs:{id:"_5-格式转换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-格式转换"}},[s._v("#")]),s._v(" （5）格式转换")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("安装dos2unix工具并转换格式")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install dos2unix")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dos2unix rancher-cluster.yaml")]),s._v("\ndos2unix: converting "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" rancher-cluster.yaml to Unix "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_6-部署k8s集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-部署k8s集群"}},[s._v("#")]),s._v(" （6）部署K8S集群")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("所有master节点登录Harbor仓库：")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker login 10.18.5.14")]),s._v("\nUsername: rancher\nPassword: \n\nWARNING"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Your password will be stored unencrypted "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" \n/root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#credentials-store")]),s._v("\n\nLogin Succeeded\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("在master01节点使用RKE启动集群")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rke up --config rancher-cluster.yaml")]),s._v("\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running RKE version: v1.1.0\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Initiating Kubernetes cluster\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dialer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Setup tunnel "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.12"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dialer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Setup tunnel "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dialer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Setup tunnel "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0234"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Finished building Kubernetes cluster successfully\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("p",[a("strong",[s._v("安装 kubectl工具")])]),s._v(" "),a("p",[a("strong",[s._v("K8S集群部署成功后会生成一个文件"),a("code",[s._v("kube_config_rancher-rancher-cluster.yaml")]),s._v("，这个文件包含kubectl和Helm访问K8S集群的凭据。")])])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("创建 kube 目录：\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir ~/.kube")]),s._v("\n\n将文件拷贝到.kube/下并重命名为 config：\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp kube_config_rancher-cluster.yaml ~/.kube/config")]),s._v("\n\n安装 kubectl 工具：\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/kubectl/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp linux-amd64-v1.18.1-kubectl kubectl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x ./kubectl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp kubectl /usr/local/bin/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl version --client")]),s._v("\nClient Version: version.Info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("Major:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v(", Minor:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"18"')]),s._v(", GitVersion:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1.18.0"')]),s._v(", GitCommit:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9e991415386e4cf155a24b1da15becaa390438d8"')]),s._v(", GitTreeState:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clean"')]),s._v(", BuildDate:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-03-25T14:58:59Z"')]),s._v(", GoVersion:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go1.13.8"')]),s._v(", Compiler:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gc"')]),s._v(", Platform:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux/amd64"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[a("strong",[s._v("查看集群状态")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get cs")]),s._v("\nNAME \t\t\t\tSTATUS \t\tMESSAGE \tERROR\ncontroller-manager \tHealthy \t\tok\nscheduler \t\t\tHealthy \t\tok\netcd-0 Healthy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\netcd-1 Healthy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\netcd-2 Healthy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_7-自动补全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-自动补全"}},[s._v("#")]),s._v(" （7）自动补全")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("安装bash-completion开启Tab键自动补全功能")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('[root@master01 ~]# yum install -y bash-completion\n[root@master01 ~]# source  /usr/share/bash-completion/bash_completion\n[root@master01 ~]# source <(kubectl completion bash)\n\n将kubectl自动补全添加到配置文件中，可以在以后的shell中自动加载:\n[root@master01 ~]# echo "source <(kubectl completion bash)" >> ~/.bashrc\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"部署rancher-ha集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署rancher-ha集群"}},[s._v("#")]),s._v(" 部署Rancher HA集群")]),s._v(" "),a("blockquote",[a("p",[a("strong",[a("code",[s._v("需要安装helm然后作为Kubernetes体系的包管理工具")])])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("helm作为应用打包交付方式")])])])]),s._v(" "),a("h4",{attrs:{id:"_1-安装helm工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装helm工具"}},[s._v("#")]),s._v(" （1）安装Helm工具")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("在master01节点安装Helm")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/helm/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 helm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -xf helm-v3.0.3-linux-amd64.tar.gz")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 helm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp linux-amd64/helm /usr/local/bin/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm version")]),s._v("\nversion.BuildInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("Version:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v3.0.3"')]),s._v(", GitCommit:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ac925eb7279f4a6955df663a0128044a8a6b7593"')]),s._v(", GitTreeState:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clean"')]),s._v(", GoVersion:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go1.13.6"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("strong",[s._v("Helm的常用命令如下")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm version \t\t\t\t\t\t查看版本")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm repo (add|index|list|remove|update) Helm 仓库的管理")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm search 查询 Chart 包，查询命令分为 helm search hub 和 helm search repo")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm pull \t\t\t\t\t\t将 Chart 包下载到本地，缺省下载最新的 Chart 版本，并且是 tgz包")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm install \t\t\t\t\t\t安装应用")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm list \t\t\t\t\t\t列出 default 命名空间的 Release 列表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm uninstall \t\t\t\t\t卸载应用")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_2-生成证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成证书"}},[s._v("#")]),s._v(" （2）生成证书")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("要保证Web浏览器到服务器的安全连接，HTTPS几乎是唯一选择。"),a("code",[s._v("在 master01 节点使用提供的脚本生成自签名证书")])])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("参数含义如下：")])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("--ssl-domain: 生成 SSL证书需要的主域名，如不指定则默认为localhost，如果是IP访问服务，则可忽略；")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("--ssl-date: SSL有效期，默认10年；")])])]),s._v(" "),a("li",[a("strong",[a("code",[s._v("--ca-date: CA有效期，默认10年。")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@master01 ~]# cd /root/offline_installation_package/cert/\n[root@master01 cert]# chmod +x create_self-signed-cert.sh\n[root@master01 cert]# ./create_self-signed-cert.sh \\\n--ssl-trusted-ip=10.18.5.10,10.18.5.11,10.18.5.12,10.18.5.13 \\\n--ssl-size=2048 \\\n--ssl-date=3650\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_3-部署rancher"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-部署rancher"}},[s._v("#")]),s._v(" （3）部署Rancher")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("在master01节点创建Rancher Server的命名空间")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create namespace cattle-system")]),s._v("\nnamespace/cattle-system created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("strong",[s._v("使用自签名证书部署Rancher，需要创建证书secret和CA证书secret。在Rancher Server的命名空间创建服务证书和私钥密文")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=./tls.crt --key=./tls.key")]),s._v("\nsecret/tls-rancher-ingress created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("strong",[s._v("在Rancher Server的命名空间创建CA证书密文")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n cattle-system create secret generic tls-ca --from-file=cacerts.pem")]),s._v("\nsecret/tls-ca created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("blockquote",[a("h4",{attrs:{id:"helm安装rancher的语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#helm安装rancher的语法"}},[s._v("#")]),s._v(" Helm安装Rancher的语法")]),s._v(" "),a("p",[s._v("很多场景需要使用IP去直接访问Rancher Server。"),a("code",[s._v("因为ingress默认不支持IP访问，所以这里禁用ingress，需要通过NodePort把Rancher Server容器443端口映射到宿主机上。")]),s._v("这个时候Rancher Server容器将作为SSL终止并配置SSL证书，将请求流量转发到Rancher Server容器的443端口，然后通过任意master节点IP+NodePort端口即可访问Rancher。")]),s._v(" "),a("p",[a("strong",[s._v("此安装方式语法如下：")])]),s._v(" "),a("p",[s._v("[root@master01 rancher-charts]# helm install rancher rancher/ --namespace  cattle-system \\")]),s._v(" "),a("p",[s._v("--set rancherImage=  \\ \t\t\t  # 指定镜像名称，不要指定镜像版本")]),s._v(" "),a("p",[s._v("--set busyboxImage=  \\")]),s._v(" "),a("p",[s._v("--set service.type=NodePort \\")]),s._v(" "),a("p",[s._v("--set service.ports.nodePort= \\ \t # 指定映射端口")]),s._v(" "),a("p",[s._v("--set privateCA=true \\")]),s._v(" "),a("p",[s._v("--set useBundledSystemChart=true \\")]),s._v(" "),a("p",[s._v("--set privateRegistry=true \\ \t\t# 设置使用私有仓库")]),s._v(" "),a("p",[s._v("--set systemDefaultRegistry= \t\t# 设置私有仓库地址，注意不要添加 协议头")])]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[a("strong",[s._v("使用helm部署rancher")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/rancher-charts/server-chart/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 server-chart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm install rancher rancher/ --namespace cattle-system \\")]),s._v("\n--set service.type"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodePort --set service.ports.nodePort"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30001")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tls")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("internal --set ingress.tls.source"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("secret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("privateCA")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rancherImage")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14/rancher/rancher "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("busyboxImage")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.14/rancher/busybox\n\n\nNAME: rancher\nLAST DEPLOYED: Mon May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":18:55 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("\nNAMESPACE: cattle-system\nSTATUS: deployed\nREVISION: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nTEST SUITE: None\nNOTES:\nRancher Server has been installed.\nNOTE: Rancher may take several minutes to fully initialize. Please standby \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" Certificates are being issued and Ingress comes up.\nCheck out our docs at https://rancher.com/docs/rancher/v2.x/en/\n\nBrowse to https://\nHappy Containering"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[a("strong",[s._v("如果Rancher Server部署过程中有问题，可以删除再重新执行helm install，删除命令如下")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm uninstall -n cattle-system rancher")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"6"}},[a("li",[a("strong",[s._v("查看Pod状态")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 server-chart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n cattle-system")]),s._v("\nNAME \t\t\t\t\tREADY STATUS  RESTARTS \tAGE\nrancher-7957bfd9f4-kj64g "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2 Running  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \t\t2m24s\nrancher-7957bfd9f4-mcj7q "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2 Running  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \t\t2m24s\nrancher-7957bfd9f4-pstc2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2 Running  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \t\t2m24s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_4-访问rancher"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-访问rancher"}},[s._v("#")]),s._v(" （4）访问Rancher")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("在Web端通过https://10.18.5.13访问Rancher")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157359.png",alt:"image-20211129103822165"}}),s._v(" "),a("p",[a("strong",[s._v("单击“Continue”按钮，设置 URL。此 URL 地址可以是 IP 也可以是域名，集群所有节点将使用该URL注册到Rancher，所以需要保证 所有节点能访问该地址。"),a("code",[s._v("如果Rancher Server是多节点HA运行，请勿设置Rancher Server URL为某一个节点的IP地址，避免因某一个节点出现故障影响整个集群")]),s._v("。如果Rancher Server URL使用域名，"),a("code",[s._v("需把域名解析到所有Rancher Server节点IP或者VIP上。")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157014.png",alt:"image-20211129104039899"}}),s._v(" "),a("p",[a("strong",[s._v("保存URL后进入Rancher全局页面，切换语言为中文简体。 在local集群中单击“┆”按钮，在下拉菜单中选择“升级”菜单命令，在跳转 页面直接单击“保存”按钮即可。")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157372.png",alt:"image-20211129104150465"}}),s._v(" "),a("p",[a("strong",[s._v("单击集群名称local进入集群仪表盘界面")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157808.png",alt:"image-20211129104249420"}}),s._v(" "),a("h4",{attrs:{id:"_5-安装rancher-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-安装rancher-cli"}},[s._v("#")]),s._v(" （5）安装Rancher CLI")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("Rancher CLI是一个统一的工具，可用于与Rancher进行交互。借助于此工具，可以操作Rancher并管理其下的资源。在master01节点解压安装包并移至/usr/bin目录下")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/offline_installation_package/rancher-cli/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar xf rancher-linux-amd64-v2.4.0.tar.gz -C /usr/local/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "export PATH=$PATH:/usr/local/rancher-v2.4.0" >> /etc/profile')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# source /etc/profile")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rancher -v")]),s._v("\nrancher version v2.4.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("strong",[s._v("登录Rancher 全局页面，单击右上角的用户图标，在用户 "),a("code",[s._v("下拉菜单中选择“API & Keys”命令进入 API &Key 管理界面。")])])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157496.png",alt:"image-20211129104454541"}}),s._v(" "),a("p",[a("strong",[s._v("在右上角的“"),a("code",[s._v("添加 Key”按钮")]),s._v("跳转到“"),a("code",[s._v("添加 API Key")]),s._v("”页面，选择永不过期和作用于所有集群")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157642.png",alt:"image-20211129104605779"}}),s._v(" "),a("p",[a("strong",[s._v("单击"),a("code",[s._v("“创建”")]),s._v("按钮后可"),a("code",[s._v("查看 Token 详细信息")]),s._v("，API Key ， "),a("code",[s._v("注意保存相关信息")]),s._v("，后期配置 CLI 会用到。")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157020.png",alt:"image-20211129104934229"}}),s._v(" "),a("p",[a("strong",[s._v("API KEY 由 4 个组件组成：")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Endpoint：")]),s._v("这是其他应用程序用于向 Rancher API 发送请求的地址。")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Access Key：")]),s._v("Token 的用户名。")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Secret Key：")]),s._v("Token 的密码。用于提示用户使用 API 身份验证的应用程序， 通常会将两个密钥一起输入。")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("Bearer Token：")]),s._v("Token 的用户名和密码连接在一起。将此字符串用于提示 用户输入一个验证字符串的应用程序。")])]),s._v(" "),a("p",[a("strong",[s._v("登录K8S集群，过程中需要输入yes确认")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rancher login https://10.18.5.13/v3 --token token-cp2jx:cn2d8dp298tncj9bvk6mwk7ppjcbp6tsl2wrb7z7qccm4p7s9r5kfk")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("验证CLI工具是否对接成功")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 rancher-cli"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rancher kubectl get nodes")]),s._v("\nNAME STATUS ROLES AGE VERSION\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.10 Ready controlplane,etcd,worker 7h12m v1.17.4\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.11 Ready controlplane,etcd,worker 7h12m v1.17.4\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.18")]),s._v(".5.12 Ready controlplane,etcd,worker 7h12m v1.17.4\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_6-启用监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-启用监控"}},[s._v("#")]),s._v(" （6）启用监控")]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("进入Rancher集群仪表盘界面")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157027.png",alt:"image-20211129105119364"}}),s._v(" "),a("p",[a("strong",[s._v("选择左侧导航栏选择“系统设置”菜单命令，"),a("code",[s._v("在 system-default-registry中添加harbor节点IP地址")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157806.png",alt:"image-20211129105152040"}}),s._v(" "),a("p",[a("strong",[s._v("选择左侧导航栏“"),a("code",[s._v("工具→监控")]),s._v("”菜单命令，根据需要修改监控配置，如图")])]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157158.png",alt:"image-20211129105253881"}}),s._v(" "),a("p",[a("strong",[s._v("单击"),a("code",[s._v("“启用监控”")]),s._v("按钮，系统会自动生成命名空间 "),a("code",[s._v("cattle-prometheus")]),s._v("，查看 该命名空间下Pod状态")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n cattle-prometheus ")]),s._v("\nNAME                                                       READY   STATUS    RESTARTS   AGE\nexporter-kube-state-cluster-monitoring-6cb8fd84bc-zk7rc    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\nexporter-node-cluster-monitoring-dsdbv                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\nexporter-node-cluster-monitoring-vhbc4                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\nexporter-node-cluster-monitoring-xvbhn                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\ngrafana-cluster-monitoring-c8988fbdb-9ctpd                 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\nprometheus-cluster-monitoring-0                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("/6     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          12h\nprometheus-operator-monitoring-operator-7b88c6ff66-td5zf   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[a("strong",[s._v("待所有 Pod 启动成功后返回集群仪表盘界面")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157423.png",alt:"image-20211129105419190"}}),s._v(" "),a("p",[a("strong",[s._v("可以看到，监控已成功启动。在仪表盘下方即可查看集群实时负载信息")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157817.png",alt:"image-20211129105447721"}}),s._v(" "),a("p",[a("strong",[s._v("此时grafana监控也启动了，可以查看集群监控")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157380.png",alt:"image-20211129105600375"}}),s._v(" "),a("h4",{attrs:{id:"_7-开启日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-开启日志"}},[s._v("#")]),s._v(" （7）开启日志")]),s._v(" "),a("p",[a("strong",[s._v("Rancher 支持两种层面的应用日志收集：")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("① 集群层面：")]),s._v("在集群层面对接日志系统后，它将收集整个集群下全部项目 的应用日志；")])]),s._v(" "),a("p",[a("strong",[a("code",[s._v("② 项目层面：")]),s._v("在项目层面对接日志系统后，它将收集本项目下应用日志。")])]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("修改内核参数")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/sysctl.conf ")]),s._v("\nvm.max_map_count"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26214")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl -p")]),s._v("\nvm.max_map_count "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26214")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[a("strong",[s._v("启动 Elasticsearch")])]),s._v(" "),a("p",[a("strong",[s._v("在cicd节点启动Elasticsearch")])])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -td -p 9200:9200 -p 9300:9300 \\")]),s._v("\n-v /opt/data/elasticsearch/esdata:/usr/share/elasticsearch/data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"discovery.type=single-node"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nelasticsearch\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("strong",[s._v("启动 Kibana")])])]),s._v(" "),a("p",[s._v("​\t"),a("strong",[s._v("在cicd节点启动Kibana（10.18.5.14 为harbor节点IP）")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cicd ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name some-kibana \\")]),s._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ELASTICSEARCH_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://10.18.5.14:9200 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n-p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5601")]),s._v(":5601 -d kibana\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[a("strong",[s._v("Rancher 对接 Elasticsearch")])])]),s._v(" "),a("p",[a("strong",[s._v("登录Rancher仪表盘界面，选择"),a("code",[s._v("“工具→日志”")]),s._v("菜单命令， 日志可以基于集群层面，也可以基于项目层面。")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157130.png",alt:"image-20211129110016023"}}),s._v(" "),a("p",[a("strong",[s._v("在图中单击"),a("code",[s._v("“Elasticsearch”")]),s._v("按钮，"),a("code",[s._v("设置访问地址和前缀")])])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157718.png",alt:"image-20211129110227610"}}),s._v(" "),a("p",[a("strong",[s._v("滑到底部，单击"),a("code",[s._v("“测试”按钮")]),s._v("，进行测试，测试结果如图所示。如 果通过则进行保存。")])]),s._v(" "),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157115.png",alt:"image-20211129110502765"}}),s._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[a("strong",[s._v("查看日志")])])]),s._v(" "),a("p",[a("strong",[s._v("登录 Kibana（http://10.18.5.14:5601），在 Index pattern 处输入日志前缀 "),a("code",[s._v("“logstash-*”")]),s._v("进行过滤，如图所示。"),a("code",[s._v("Time Filter field name")]),s._v(" 的下拉菜单选 项选择"),a("code",[s._v("“I don't want to use the Time Filter.”")]),s._v("。")])]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157081.png",alt:"image-20211129110639009"}}),s._v(" "),a("p",[a("strong",[s._v("单击“create”按钮，跳转至过滤后的日志页面")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157376.png",alt:"image-20211129110724601"}}),s._v(" "),a("p",[a("strong",[s._v("在 Rancher 集群仪表盘界面下方单击"),a("code",[s._v("“Rancher 日志功能监控”")]),s._v("按钮，可以 查看")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204111157179.png",alt:"image-20211129110826525"}})])}),[],!1,null,null,null);t.default=e.exports}}]);