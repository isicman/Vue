(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{549:function(s,t,a){"use strict";a.r(t);var n=a(19),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab-runner-k8s-实现自动部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner-k8s-实现自动部署"}},[s._v("#")]),s._v(" Gitlab-Runner + k8s 实现自动部署")]),s._v(" "),a("h2",{attrs:{id:"过程说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#过程说明"}},[s._v("#")]),s._v(" 过程说明")]),s._v(" "),a("ol",[a("li",[s._v("想要实现自动部署，就要借助工具"),a("code",[s._v("kubectl")]),s._v("安装文档 https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-linux")]),s._v(" "),a("li",[s._v("将该工具集成到 alpine 镜像里面，当然也可以去 docker 仓库找个现成的")]),s._v(" "),a("li",[s._v("准备好 k8s 配置文件，使得"),a("code",[s._v("kubectl")]),s._v("工具能连接上 k8s 集群")]),s._v(" "),a("li",[s._v("准备部署的命令，这里又分两种情况，一种是删掉 deployment 重新部署 ，另一种是更新 deployment 以重启 pod。第一种需要准备 deployment 的配置文件，而每次更新只是拉取新的镜像而已，因此这里选择第二种。第二种实现的方式是添加一个时间变量，触发 pod 更新，以免系统认为配置文件不变而没有更新 pod")])]),s._v(" "),a("h2",{attrs:{id:"准备kubectl镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备kubectl镜像"}},[s._v("#")]),s._v(" 准备kubectl镜像")]),s._v(" "),a("h3",{attrs:{id:"_1-编排dockerfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编排dockerfile"}},[s._v("#")]),s._v(" 1.编排Dockerfile")]),s._v(" "),a("p",[s._v("因为Kubelet是作为一个工具，所以我们需要将"),a("code",[s._v("kubelet")]),s._v("工具安装到"),a("code",[s._v("alpine")]),s._v("镜像中。")]),s._v(" "),a("div",{staticClass:"language-dockerfile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[s._v("[root@k8s-master ~]# cat Dockerfile\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" alpine:latest")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" KUBE_LATEST_VERSION=v1.15.3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# RUN apk add --update ca-certificates")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add --update -t deps curl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" curl -L https://storage.googleapis.com/kubernetes-release/release/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${KUBE_LATEST_VERSION}")]),s._v("/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" chmod +x /usr/local/bin/kubectl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk del --purge deps")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" rm /var/cache/apk/*")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"_2-构建镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-构建镜像"}},[s._v("#")]),s._v(" 2.构建镜像")]),s._v(" "),a("p",[s._v("通过Docker build构建镜像")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# docker build --build-arg KUBE_LATEST_VERSION="v1.16.6" -t kubectl:v1.16.6 .')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"准备k8s配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备k8s配置文件"}},[s._v("#")]),s._v(" 准备k8s配置文件")]),s._v(" "),a("ol",[a("li",[s._v("配置文件也可以集成在镜像里面，但是不太灵活，一旦配置有变或者有多个集群，镜像就得修改或者准备多个版本，因此通过 gitlab ci/cd 环境变量传递")]),s._v(" "),a("li",[s._v("首先取得配置信息，通过命令"),a("code",[s._v("kubectl config view --raw -o yaml")]),s._v("得到配置信息，复制到 gitlab 的 ci/cd 环境变量中")]),s._v(" "),a("li",[s._v("这里要注意的是，命令必须带参数"),a("code",[s._v("--raw")]),s._v("，为了将 certificate-authority-data 的值输出，否则只能看到 DATA+OMITTED。另外，环境变量必须选择文件类型，否则最后输出格式不对，导致"),a("code",[s._v("mapping values are not allowed in this context")]),s._v("错误，当然选择"),a("code",[s._v("-o json")]),s._v("，使用 json 格式，就不用担心格式问题")])]),s._v(" "),a("h3",{attrs:{id:"_1-复制config"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-复制config"}},[s._v("#")]),s._v(" 1.复制config")]),s._v(" "),a("p",[s._v("通过"),a("code",[s._v("kubectl config")]),s._v("命令查看也可以直接"),a("code",[s._v("cat ~/.kube/config")]),s._v(" 查看。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl config view --raw -o yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_2-在gitlab添加变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-在gitlab添加变量"}},[s._v("#")]),s._v(" 2.在GitLab添加变量")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v('"Settings"')]),s._v("选择中找到"),a("code",[s._v("“CI/CD”")]),s._v("，点击"),a("code",[s._v("“Variables”")]),s._v("。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204240956975.png",alt:"image-20220423231346639"}})]),s._v(" "),a("p",[s._v("点击"),a("code",[s._v("“Add variable”")]),s._v(" 添加变量。添加"),a("code",[s._v("K8S_CONFIG")]),s._v("对应的值是"),a("code",[s._v("config")]),s._v("内容。")]),s._v(" "),a("p",[s._v("变量"),a("code",[s._v("$KUBE_CONFIG")]),s._v(" 实际上是个地址，因为 "),a("code",[s._v("gitlab ci/cd")]),s._v(" 环境变量类型设置为 "),a("code",[s._v("file")]),s._v("。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204240956911.png",alt:"image-20220423231824145"}})]),s._v(" "),a("h3",{attrs:{id:"_3-gitlab其他细节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-gitlab其他细节"}},[s._v("#")]),s._v(" 3. Gitlab其他细节")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("还有个就是网络问题。gitlab-runner 创建的这个基于"),a("code",[s._v("kubectl:v1.16.6")]),s._v("镜像的容器，是访问不到 k8s 集群的，因为不是在同一个网络，而 k8s 集群又没设置通过外网访问。这里的简单处理方法是在 gitlab-runner 配置中，将网络模式设置为 host，因为这里是 microk8s 创建的单节点集群，总之只要达到使他们处于同一个网络或者可以访问即可。")])]),s._v(" "),a("li",[a("p",[s._v("Gitlab Runner每次执行都会拉取docker镜像的问题。找到搭建Gitlab Runner时创建的"),a("code",[s._v("config.toml")]),s._v("文件，加上："),a("code",[s._v("pull_policy = “if-not-present”")])])]),s._v(" "),a("li",[a("p",[s._v("配置的两个参数：")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("pull_policy")]),s._v(" = "),a("strong",[s._v('"if-not-present"')])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("network_mode")]),s._v(" = "),a("strong",[s._v('"host"')])])])])])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /srv/gitlab-runner/config/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat config.toml")]),s._v("\nconcurrent = 1\ncheck_interval = 0\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("session_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  session_timeout = 1800\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n  name = "first'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("register"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('runner"\n  url = "http'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('//10.11.121.111/"\n  token = "'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('qu5oc3WSLxUbGd7hQri"\n  executor = "docker"\n  '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.custom_build_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.gcs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.cache.azure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("runners.docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    tls_verify = false\n    image = "alpine'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('latest"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v('\n    shm_size = 0\n    pull_policy = "if'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("not"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('present"\t'),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加镜像策略")]),s._v('\n    network_mode = "host"\t\t\t'),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网络模式为host")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h2",{attrs:{id:"配置cicd流水线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置cicd流水线"}},[s._v("#")]),s._v(" 配置CICD流水线")]),s._v(" "),a("h3",{attrs:{id:"_1-添加配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加配置"}},[s._v("#")]),s._v(" 1.添加配置")]),s._v(" "),a("p",[s._v("这里在CICD的流水线中添加如下配置，配置使用镜像"),a("code",[s._v("kubelet:1.16.6")]),s._v(",将变量输出到"),a("code",[s._v("config")]),s._v("的文件中，访问K8s集群测试。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.16.6\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" cat $K8S_CONFIG "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" $HOME/.kube/config\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" cd $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" pwd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kubectl get pods "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("A \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"_2-测试流水线脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-测试流水线脚本"}},[s._v("#")]),s._v(" 2.测试流水线脚本")]),s._v(" "),a("p",[s._v("提交本次的流水线修改。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204240956264.png",alt:"image-20220423232659395"}})]),s._v(" "),a("p",[s._v("查看Jobs的情况，输出的日志可以看出当前配置的连接K8S正常。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/2756864799zhang/image/main/img/202204240956733.png",alt:"image-20220423232819797"}})])])}),[],!1,null,null,null);t.default=e.exports}}]);